---
// Protect Route handled by Middleware (Zero Trust)
import Layout from "../../../layouts/Layout.astro";
const env = Astro.locals.runtime.env;

// Helper for safe DB queries
async function safeFetch<T>(promise: Promise<T>, fallback: T): Promise<T> {
  try {
    return await promise;
  } catch (e) {
    console.error("DB Error:", e);
    return fallback;
  }
}

// Analytics Data
const postCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM posts").first<number>("count"),
  0,
);

const userCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM users").first<number>("count"),
  0,
);

const activeSessionCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM sessions WHERE expires_at > ?")
    .bind(Date.now())
    .first<number>("count"),
  0,
);

// Prevent Caching
Astro.response.headers.set(
  "Cache-Control",
  "no-cache, no-store, must-revalidate",
);
Astro.response.headers.set("Pragma", "no-cache");
Astro.response.headers.set("Expires", "0");
const recentPosts = await safeFetch(
  env.DB.prepare(
    "SELECT * FROM posts ORDER BY published_at DESC LIMIT 10",
  ).all(),
  // @ts-expect-error
  { results: [], success: false, meta: {} },
);

// Detailed Lists for Modals
const activeSessionsList = await safeFetch(
  env.DB.prepare(
    `
    SELECT 
      sessions.id as session_id,
      sessions.ip_address, 
      sessions.user_agent, 
      sessions.last_active, 
      sessions.created_at as session_created,
      sessions.city,
      sessions.country,
      
      -- Network & ISP
      sessions.asn,
      sessions.as_organization,
      sessions.colo,
      sessions.continent,
      sessions.timezone,
      
      -- Enhanced Geolocation
      sessions.latitude,
      sessions.longitude,
      sessions.postal_code,
      sessions.region,
      sessions.region_code,
      
      -- Connection Details
      sessions.http_protocol,
      sessions.tls_version,
      sessions.tls_cipher,
      sessions.client_tcp_rtt,
      
      -- Security & Trust
      sessions.client_trust_score,
      sessions.is_eu_country,

      -- Device Information
      sessions.screen_resolution,
      sessions.device_memory,
      sessions.cpu_cores,
      sessions.connection_type,
      
      users.username, 
      users.avatar,
      users.id as user_id,
      users.github_username,
      users.google_username,
      users.discord_username
    FROM sessions 
    LEFT JOIN users ON sessions.user_id = users.id 
    WHERE sessions.expires_at > ? 
    ORDER BY sessions.last_active DESC
  `,
  )
    .bind(Date.now())
    .all(),
  // @ts-expect-error
  { results: [] },
);

const usersList = await safeFetch(
  env.DB.prepare(`
    SELECT 
      users.*,
      latest_session.last_active,
      latest_session.ip_address,
      latest_session.city,
      latest_session.country,
      latest_session.device_memory,
      latest_session.connection_type
    FROM users
    LEFT JOIN (
      SELECT 
        user_id, 
        MAX(last_active) as last_active,
        ip_address,
        city,
        country,
        device_memory,
        connection_type
      FROM sessions
      GROUP BY user_id
    ) as latest_session ON users.id = latest_session.user_id
    ORDER BY users.rowid DESC 
    LIMIT 100
  `).all(),
  // @ts-expect-error
  { results: [] },
);

// Edge Analytics Queries
const edgeNodeStats = await safeFetch(
  env.DB.prepare(
    `
    SELECT 
      colo,
      COUNT(*) as session_count,
      AVG(client_tcp_rtt) as avg_rtt,
      country,
      continent
    FROM sessions
    WHERE expires_at > ? AND colo IS NOT NULL
    GROUP BY colo
    ORDER BY session_count DESC
  `,
  )
    .bind(Date.now())
    .all(),
  // @ts-expect-error
  { results: [] },
);

const performanceSummary = await safeFetch(
  env.DB.prepare(
    `
    SELECT 
      AVG(client_tcp_rtt) as global_avg_rtt,
      MIN(client_tcp_rtt) as min_rtt,
      MAX(client_tcp_rtt) as max_rtt,
      COUNT(DISTINCT colo) as active_nodes
    FROM sessions
    WHERE expires_at > ? AND client_tcp_rtt IS NOT NULL
  `,
  )
    .bind(Date.now())
    .first(),
  null,
);

// Edge Node Location Mapping (100+ Major Cloudflare Nodes)
const COLO_LOCATIONS: Record<
  string,
  { city: string; country: string; region: string; flag: string }
> = {
  // North America - US West
  SJC: { city: "San Jose", country: "US", region: "California", flag: "ðŸ‡ºðŸ‡¸" },
  LAX: { city: "Los Angeles", country: "US", region: "California", flag: "ðŸ‡ºðŸ‡¸" },
  SFO: {
    city: "San Francisco",
    country: "US",
    region: "California",
    flag: "ðŸ‡ºðŸ‡¸",
  },
  SEA: { city: "Seattle", country: "US", region: "Washington", flag: "ðŸ‡ºðŸ‡¸" },
  PDX: { city: "Portland", country: "US", region: "Oregon", flag: "ðŸ‡ºðŸ‡¸" },
  SAN: { city: "San Diego", country: "US", region: "California", flag: "ðŸ‡ºðŸ‡¸" },
  PHX: { city: "Phoenix", country: "US", region: "Arizona", flag: "ðŸ‡ºðŸ‡¸" },
  LAS: { city: "Las Vegas", country: "US", region: "Nevada", flag: "ðŸ‡ºðŸ‡¸" },
  DEN: { city: "Denver", country: "US", region: "Colorado", flag: "ðŸ‡ºðŸ‡¸" },
  SLC: { city: "Salt Lake City", country: "US", region: "Utah", flag: "ðŸ‡ºðŸ‡¸" },
  // US Central
  ORD: { city: "Chicago", country: "US", region: "Illinois", flag: "ðŸ‡ºðŸ‡¸" },
  DFW: { city: "Dallas", country: "US", region: "Texas", flag: "ðŸ‡ºðŸ‡¸" },
  IAH: { city: "Houston", country: "US", region: "Texas", flag: "ðŸ‡ºðŸ‡¸" },
  AUS: { city: "Austin", country: "US", region: "Texas", flag: "ðŸ‡ºðŸ‡¸" },
  MSP: { city: "Minneapolis", country: "US", region: "Minnesota", flag: "ðŸ‡ºðŸ‡¸" },
  MCI: { city: "Kansas City", country: "US", region: "Missouri", flag: "ðŸ‡ºðŸ‡¸" },
  DTW: { city: "Detroit", country: "US", region: "Michigan", flag: "ðŸ‡ºðŸ‡¸" },
  CMH: { city: "Columbus", country: "US", region: "Ohio", flag: "ðŸ‡ºðŸ‡¸" },
  BNA: { city: "Nashville", country: "US", region: "Tennessee", flag: "ðŸ‡ºðŸ‡¸" },
  // US East
  IAD: { city: "Ashburn", country: "US", region: "Virginia", flag: "ðŸ‡ºðŸ‡¸" },
  EWR: { city: "Newark", country: "US", region: "New Jersey", flag: "ðŸ‡ºðŸ‡¸" },
  BOS: { city: "Boston", country: "US", region: "Massachusetts", flag: "ðŸ‡ºðŸ‡¸" },
  PHL: {
    city: "Philadelphia",
    country: "US",
    region: "Pennsylvania",
    flag: "ðŸ‡ºðŸ‡¸",
  },
  ATL: { city: "Atlanta", country: "US", region: "Georgia", flag: "ðŸ‡ºðŸ‡¸" },
  MIA: { city: "Miami", country: "US", region: "Florida", flag: "ðŸ‡ºðŸ‡¸" },
  MCO: { city: "Orlando", country: "US", region: "Florida", flag: "ðŸ‡ºðŸ‡¸" },
  CLT: { city: "Charlotte", country: "US", region: "N. Carolina", flag: "ðŸ‡ºðŸ‡¸" },
  // Canada
  YYZ: { city: "Toronto", country: "CA", region: "Ontario", flag: "ðŸ‡¨ðŸ‡¦" },
  YVR: { city: "Vancouver", country: "CA", region: "BC", flag: "ðŸ‡¨ðŸ‡¦" },
  YUL: { city: "Montreal", country: "CA", region: "Quebec", flag: "ðŸ‡¨ðŸ‡¦" },
  // Mexico
  MEX: { city: "Mexico City", country: "MX", region: "CDMX", flag: "ðŸ‡²ðŸ‡½" },
  GDL: { city: "Guadalajara", country: "MX", region: "Jalisco", flag: "ðŸ‡²ðŸ‡½" },
  MTY: { city: "Monterrey", country: "MX", region: "Nuevo LeÃ³n", flag: "ðŸ‡²ðŸ‡½" },

  // Europe - West
  LHR: { city: "London", country: "GB", region: "England", flag: "ðŸ‡¬ðŸ‡§" },
  MAN: { city: "Manchester", country: "GB", region: "England", flag: "ðŸ‡¬ðŸ‡§" },
  DUB: { city: "Dublin", country: "IE", region: "Leinster", flag: "ðŸ‡®ðŸ‡ª" },
  AMS: {
    city: "Amsterdam",
    country: "NL",
    region: "North Holland",
    flag: "ðŸ‡³ðŸ‡±",
  },
  BRU: { city: "Brussels", country: "BE", region: "Brussels", flag: "ðŸ‡§ðŸ‡ª" },
  CDG: { city: "Paris", country: "FR", region: "ÃŽle-de-France", flag: "ðŸ‡«ðŸ‡·" },
  MRS: { city: "Marseille", country: "FR", region: "PACA", flag: "ðŸ‡«ðŸ‡·" },
  LYS: { city: "Lyon", country: "FR", region: "Auvergne", flag: "ðŸ‡«ðŸ‡·" },
  FRA: { city: "Frankfurt", country: "DE", region: "Hesse", flag: "ðŸ‡©ðŸ‡ª" },
  MUC: { city: "Munich", country: "DE", region: "Bavaria", flag: "ðŸ‡©ðŸ‡ª" },
  HAM: { city: "Hamburg", country: "DE", region: "Hamburg", flag: "ðŸ‡©ðŸ‡ª" },
  ZRH: { city: "Zurich", country: "CH", region: "Zurich", flag: "ðŸ‡¨ðŸ‡­" },
  // Europe - South
  MAD: { city: "Madrid", country: "ES", region: "Madrid", flag: "ðŸ‡ªðŸ‡¸" },
  BCN: { city: "Barcelona", country: "ES", region: "Catalonia", flag: "ðŸ‡ªðŸ‡¸" },
  LIS: { city: "Lisbon", country: "PT", region: "Lisbon", flag: "ðŸ‡µðŸ‡¹" },
  MXP: { city: "Milan", country: "IT", region: "Lombardy", flag: "ðŸ‡®ðŸ‡¹" },
  FCO: { city: "Rome", country: "IT", region: "Lazio", flag: "ðŸ‡®ðŸ‡¹" },
  ATH: { city: "Athens", country: "GR", region: "Attica", flag: "ðŸ‡¬ðŸ‡·" },
  // Europe - North & East
  ARN: { city: "Stockholm", country: "SE", region: "Stockholm", flag: "ðŸ‡¸ðŸ‡ª" },
  CPH: { city: "Copenhagen", country: "DK", region: "Capital", flag: "ðŸ‡©ðŸ‡°" },
  OSL: { city: "Oslo", country: "NO", region: "Oslo", flag: "ðŸ‡³ðŸ‡´" },
  HEL: { city: "Helsinki", country: "FI", region: "Uusimaa", flag: "ðŸ‡«ðŸ‡®" },
  VIE: { city: "Vienna", country: "AT", region: "Vienna", flag: "ðŸ‡¦ðŸ‡¹" },
  WAW: { city: "Warsaw", country: "PL", region: "Mazovia", flag: "ðŸ‡µðŸ‡±" },
  PRG: { city: "Prague", country: "CZ", region: "Prague", flag: "ðŸ‡¨ðŸ‡¿" },
  BUD: { city: "Budapest", country: "HU", region: "Budapest", flag: "ðŸ‡­ðŸ‡º" },
  SOF: { city: "Sofia", country: "BG", region: "Sofia", flag: "ðŸ‡§ðŸ‡¬" },
  DME: { city: "Moscow", country: "RU", region: "Moscow", flag: "ðŸ‡·ðŸ‡º" },
  LED: {
    city: "St. Petersburg",
    country: "RU",
    region: "Leningrad",
    flag: "ðŸ‡·ðŸ‡º",
  },
  IST: { city: "Istanbul", country: "TR", region: "Istanbul", flag: "ðŸ‡¹ðŸ‡·" },

  // Asia - East Asia
  NRT: { city: "Tokyo", country: "JP", region: "Kanto", flag: "ðŸ‡¯ðŸ‡µ" },
  KIX: { city: "Osaka", country: "JP", region: "Kansai", flag: "ðŸ‡¯ðŸ‡µ" },
  ICN: { city: "Seoul", country: "KR", region: "Seoul", flag: "ðŸ‡°ðŸ‡·" },
  HKG: { city: "Hong Kong", country: "HK", region: "Hong Kong", flag: "ðŸ‡­ðŸ‡°" },
  TPE: { city: "Taipei", country: "TW", region: "Taipei", flag: "ðŸ‡¹ðŸ‡¼" },
  // Southeast Asia
  SIN: { city: "Singapore", country: "SG", region: "Singapore", flag: "ðŸ‡¸ðŸ‡¬" },
  KUL: { city: "Kuala Lumpur", country: "MY", region: "Selangor", flag: "ðŸ‡²ðŸ‡¾" },
  BKK: { city: "Bangkok", country: "TH", region: "Bangkok", flag: "ðŸ‡¹ðŸ‡­" },
  MNL: { city: "Manila", country: "PH", region: "Metro Manila", flag: "ðŸ‡µðŸ‡­" },
  CGK: { city: "Jakarta", country: "ID", region: "Jakarta", flag: "ðŸ‡®ðŸ‡©" },
  HAN: { city: "Hanoi", country: "VN", region: "Hanoi", flag: "ðŸ‡»ðŸ‡³" },
  SGN: { city: "Ho Chi Minh", country: "VN", region: "HCMC", flag: "ðŸ‡»ðŸ‡³" },
  // South Asia
  BOM: { city: "Mumbai", country: "IN", region: "Maharashtra", flag: "ðŸ‡®ðŸ‡³" },
  DEL: { city: "Delhi", country: "IN", region: "Delhi", flag: "ðŸ‡®ðŸ‡³" },
  BLR: { city: "Bangalore", country: "IN", region: "Karnataka", flag: "ðŸ‡®ðŸ‡³" },
  HYD: { city: "Hyderabad", country: "IN", region: "Telangana", flag: "ðŸ‡®ðŸ‡³" },
  MAA: { city: "Chennai", country: "IN", region: "Tamil Nadu", flag: "ðŸ‡®ðŸ‡³" },
  // Oceania
  SYD: { city: "Sydney", country: "AU", region: "NSW", flag: "ðŸ‡¦ðŸ‡º" },
  MEL: { city: "Melbourne", country: "AU", region: "Victoria", flag: "ðŸ‡¦ðŸ‡º" },
  BNE: { city: "Brisbane", country: "AU", region: "Queensland", flag: "ðŸ‡¦ðŸ‡º" },
  PER: { city: "Perth", country: "AU", region: "WA", flag: "ðŸ‡¦ðŸ‡º" },
  AKL: { city: "Auckland", country: "NZ", region: "Auckland", flag: "ðŸ‡³ðŸ‡¿" },

  // Middle East & Africa
  DXB: { city: "Dubai", country: "AE", region: "Dubai", flag: "ðŸ‡¦ðŸ‡ª" },
  BAH: { city: "Bahrain", country: "BH", region: "Manama", flag: "ðŸ‡§ðŸ‡­" },
  DOH: { city: "Doha", country: "QA", region: "Doha", flag: "ðŸ‡¶ðŸ‡¦" },
  AMM: { city: "Amman", country: "JO", region: "Amman", flag: "ðŸ‡¯ðŸ‡´" },
  TLV: { city: "Tel Aviv", country: "IL", region: "Tel Aviv", flag: "ðŸ‡®ðŸ‡±" },
  CAI: { city: "Cairo", country: "EG", region: "Cairo", flag: "ðŸ‡ªðŸ‡¬" },
  JNB: { city: "Johannesburg", country: "ZA", region: "Gauteng", flag: "ðŸ‡¿ðŸ‡¦" },
  CPT: { city: "Cape Town", country: "ZA", region: "Western Cape", flag: "ðŸ‡¿ðŸ‡¦" },
  NBO: { city: "Nairobi", country: "KE", region: "Nairobi", flag: "ðŸ‡°ðŸ‡ª" },
  LOS: { city: "Lagos", country: "NG", region: "Lagos", flag: "ðŸ‡³ðŸ‡¬" },

  // South America
  GRU: { city: "SÃ£o Paulo", country: "BR", region: "SÃ£o Paulo", flag: "ðŸ‡§ðŸ‡·" },
  GIG: { city: "Rio de Janeiro", country: "BR", region: "Rio", flag: "ðŸ‡§ðŸ‡·" },
  SCL: { city: "Santiago", country: "CL", region: "Santiago", flag: "ðŸ‡¨ðŸ‡±" },
  BOG: { city: "BogotÃ¡", country: "CO", region: "BogotÃ¡", flag: "ðŸ‡¨ðŸ‡´" },
  LIM: { city: "Lima", country: "PE", region: "Lima", flag: "ðŸ‡µðŸ‡ª" },
  EZE: {
    city: "Buenos Aires",
    country: "AR",
    region: "Buenos Aires",
    flag: "ðŸ‡¦ðŸ‡·",
  },
};
---

<Layout title="Dashboard - Ichimaru Gin">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header
      class="mb-12 flex flex-col md:flex-row justify-between items-center gap-6"
    >
      <div class="flex items-center gap-8 w-full md:w-auto">
        <div>
          <h1
            class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-brand-primary"
          >
            Analytics Center
          </h1>
          <p class="text-gray-400 mt-2">Real-time data stream.</p>
        </div>

        <!-- Admin Search Box -->
        <div class="hidden md:block relative group flex-1 min-w-[300px] z-20">
          <input
            type="text"
            id="admin-search-input"
            placeholder="Search Global Signals..."
            class="w-full bg-black/40 border border-white/10 rounded-full px-5 py-2.5 focus:outline-none focus:border-brand-accent focus:bg-black/60 transition-all text-white text-sm"
          />
          <div
            id="admin-search-results"
            class="absolute top-full left-0 mt-2 w-full glass-panel rounded-2xl p-2 hidden z-50"
          >
            <!-- Results injected here -->
          </div>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <a
          href="/IchimaruGin728/admin/music"
          class="px-4 py-2 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-colors text-sm flex items-center gap-2"
        >
          <span class="i-heroicons-musical-note"></span>
          Music Manager
        </a>
        <a
          href="/"
          class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 transition-colors text-sm"
        >
          Back to Site
        </a>
      </div>
    </header>

    <!-- Analytics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-12">
      <div class="glass-panel p-6 rounded-2xl">
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Total Signals
        </div>
        <div class="text-4xl font-bold font-display">{postCount}</div>
      </div>

      <!-- Users Card (Clickable) -->
      <div
        class="glass-panel p-6 rounded-2xl cursor-pointer hover:bg-white/5 transition-colors group relative"
        onclick="openInspector('users')"
      >
        <div
          class="absolute top-4 right-4 text-gray-500 group-hover:text-white transition-colors"
        >
          <span class="i-heroicons-users w-5 h-5"></span>
        </div>
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Total Users
        </div>
        <div
          class="text-4xl font-bold font-display group-hover:text-brand-accent transition-colors"
        >
          {userCount}
        </div>
        <div
          class="text-xs text-gray-500 mt-2 flex items-center gap-1 group-hover:text-brand-accent/70 transition-colors"
        >
          <span>View Details</span>
          <span class="i-heroicons-arrow-right w-3 h-3"></span>
        </div>
      </div>

      <!-- Sessions Card (Clickable) -->
      <div
        class="glass-panel p-6 rounded-2xl cursor-pointer hover:bg-white/5 transition-colors group relative"
        onclick="openInspector('sessions')"
      >
        <div
          class="absolute top-4 right-4 text-gray-500 group-hover:text-white transition-colors"
        >
          <span class="i-heroicons-globe-alt w-5 h-5"></span>
        </div>
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Active Sessions
        </div>
        <div
          class="text-4xl font-bold font-display group-hover:text-green-400 transition-colors"
        >
          {activeSessionCount}
        </div>
        <div
          class="text-xs text-gray-500 mt-2 flex items-center gap-1 group-hover:text-green-400/70 transition-colors"
        >
          <span>Inspect Traffic</span>
          <span class="i-heroicons-arrow-right w-3 h-3"></span>
        </div>
      </div>

      <!-- Edge Analytics Card (Clickable) -->
      <div
        class="glass-panel p-6 rounded-2xl cursor-pointer hover:bg-white/5 transition-colors group relative"
        onclick="openInspector('edge')"
      >
        <div
          class="absolute top-4 right-4 text-gray-500 group-hover:text-white transition-colors"
        >
          <span class="i-heroicons-server w-5 h-5"></span>
        </div>
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Edge Nodes
        </div>
        <div
          class="text-4xl font-bold font-display group-hover:text-blue-400 transition-colors"
        >
          {performanceSummary?.active_nodes || 0}
        </div>
        <div
          class="text-xs text-gray-500 mt-2 flex items-center gap-1 group-hover:text-blue-400/70 transition-colors"
        >
          <span
            >Avg {
              Math.round(Number(performanceSummary?.global_avg_rtt || 0))
            }ms</span
          >
        </div>
      </div>

      <div
        class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-brand-primary/20 to-transparent border-brand-primary/30"
      >
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          System Status
        </div>
        <div class="flex items-center gap-2 text-green-400 font-bold">
          <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
          OPERATIONAL
        </div>
      </div>
    </div>
  </div>

  <!-- Signal Log List -->
  <div class="glass-panel p-8 rounded-3xl mb-12">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Signal Log</h2>
      <div id="signal-log-count" class="text-xs font-mono text-gray-400">
        Showing Recent 10
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse" id="signal-log-table">
        <thead>
          <tr
            class="text-gray-400 border-b border-white/10 text-xs uppercase tracking-wider font-mono"
          >
            <th class="py-4 font-normal">Status</th>
            <th class="py-4 font-normal">Title</th>
            <th class="py-4 font-normal">Published</th>
            <th class="py-4 font-normal text-right">Views</th>
            <th class="py-4 font-normal text-right">Action</th>
          </tr>
        </thead>
        <tbody class="text-sm" id="signal-log-body">
          {
            (recentPosts.results || []).map((post: any) => {
              const isPublished = Date.now() >= (post.published_at || 0);
              return (
                <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                  <td class="py-4">
                    <span
                      class={`inline-block w-2 h-2 rounded-full ${isPublished ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]" : "bg-yellow-400"}`}
                    />
                  </td>
                  <td class="py-4 font-medium text-white">{post.title}</td>
                  <td class="py-4 text-gray-400 font-mono text-xs">
                    {new Date(
                      post.published_at || post.created_at,
                    ).toLocaleDateString()}
                  </td>
                  <td class="py-4 text-right">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-white/5 border border-white/10 text-xs font-mono">
                      <span class="i-heroicons-eye w-3 h-3 text-gray-500" />
                      {post.views || 0}
                    </span>
                  </td>
                  <td class="py-4 text-right flex items-center justify-end gap-2">
                    <button
                      class="edit-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-brand-primary/20 text-gray-300 hover:text-brand-accent border border-white/10 hover:border-brand-primary/50 transition-all text-xs"
                      data-slug={post.slug}
                      title="Edit Post"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                        />
                      </svg>
                    </button>
                    <button
                      class="toggle-status-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-gray-300 hover:text-yellow-400 border border-white/10 hover:border-yellow-500/50 transition-all text-xs"
                      data-slug={post.slug}
                      data-status={isPublished ? "published" : "draft"}
                      title={
                        isPublished ? "Unpublish (Hide)" : "Publish (Show)"
                      }
                    >
                      {isPublished ? (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="w-4 h-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"
                          />
                        </svg>
                      ) : (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="w-4 h-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                          />
                        </svg>
                      )}
                    </button>
                    <button
                      class="delete-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/10 hover:border-red-500/50 transition-all text-xs"
                      data-slug={post.slug}
                      title="Delete Post"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                        />
                      </svg>
                    </button>
                  </td>
                </tr>
              );
            })
          }
        </tbody>
      </table>
    </div>

    <div class="mt-6 flex justify-center">
      <button
        id="load-all-signals-btn"
        class="px-6 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-mono tracking-widest uppercase transition-colors text-gray-400 hover:text-white"
      >
        Load Full Archive
      </button>
    </div>
  </div>

  <!-- Editor Section -->
  <div class="glass-panel p-8 rounded-3xl">
    <h2 class="text-2xl font-bold mb-6">Transmission Uplink</h2>

    <!-- Quick Publish via File -->
    <div class="mb-12 p-6 rounded-2xl bg-white/5 border border-white/10">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        <span class="i-heroicons-document-arrow-up"></span>
        Direct Uplink (File)
      </h3>
      <p class="text-sm text-gray-400 mb-4">
        Upload <code>.md</code> or <code>.rtf</code> files to publish immediately.
      </p>
      <div class="flex items-center gap-4">
        <input
          type="file"
          id="quick-publish-file"
          accept=".md,.markdown,.rtf,.txt"
          class="block w-full text-sm text-gray-400
            file:mr-4 file:py-2 file:px-4
            file:rounded-full file:border-0
            file:text-xs file:font-bold
            file:bg-brand-accent/10 file:text-brand-accent
            hover:file:bg-brand-accent/20"
        />
        <button
          id="quick-publish-btn"
          class="px-5 py-2 whitespace-nowrap rounded-xl bg-white/10 hover:bg-white/20 border border-white/10 text-white font-medium transition-colors flex items-center gap-2"
        >
          <span class="i-heroicons-paper-airplane"></span>
          Publish
        </button>
      </div>
      <div id="quick-publish-status" class="mt-3 text-sm hidden"></div>
    </div>

    <form id="create-post-form" class="space-y-6">
      <input type="hidden" name="id" id="post-id" />
      <div class="grid grid-cols-3 gap-6">
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >SIGNAL_TITLE</label
          >
          <input
            type="text"
            name="title"
            id="title-input"
            required
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >SIGNAL_SLUG</label
          >
          <input
            type="text"
            name="slug"
            id="slug-input"
            required
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >PUBLISHED_AT</label
          >
          <input
            type="datetime-local"
            name="publishedAt"
            id="published-at-input"
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white calendar-picker-indicator:invert"
          />
          <p class="text-xs text-gray-500 mt-1">
            Set a past or future date to override publication time
          </p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >UPDATED_AT</label
          >
          <div class="flex items-center gap-4">
            <input
              type="datetime-local"
              name="updatedAt"
              id="updated-at-input"
              class="flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white disabled:opacity-50"
              disabled
            />
            <label class="flex items-center gap-2 cursor-pointer group">
              <input
                type="checkbox"
                id="auto-update-toggle"
                checked
                class="w-5 h-5 rounded border-white/20 bg-white/5 text-brand-accent focus:ring-brand-accent focus:ring-offset-0 transition-all"
              />
              <span
                class="text-xs text-gray-400 group-hover:text-gray-200 transition-colors"
                >Auto-Update</span
              >
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Manually override modification time or keep it automatic
          </p>
        </div>
      </div>
    </form>

    <!-- Markdown Editor with Toolbar -->
    <div class="border border-white/10 rounded-xl overflow-hidden bg-black/20">
      <div
        class="flex items-center gap-2 p-2 border-b border-white/10 bg-white/5"
      >
        <button
          type="button"
          class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
          title="Bold">B</button
        >
        <button
          type="button"
          class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
          title="Italic">I</button
        >
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <button
          type="button"
          id="upload-btn"
          class="flex items-center gap-2 px-3 py-1.5 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors text-sm"
        >
          <span class="i-heroicons-photo"></span>
          Upload Media
        </button>
        <input
          type="file"
          id="file-input"
          class="hidden"
          accept="image/*, .gif, .ppt, .pptx, .doc, .docx, .xls, .xlsx, .csv"
        />
      </div>
      <textarea
        id="content-area"
        name="content"
        form="create-post-form"
        rows="15"
        required
        class="w-full bg-transparent p-4 focus:outline-none font-mono text-sm leading-relaxed resize-y"
        placeholder="Initiate transmission..."></textarea>
    </div>

    <div class="flex items-center gap-4">
      <button
        type="submit"
        form="create-post-form"
        class="relative z-10 flex-1 py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-accent hover:opacity-90 hover:scale-[1.01] active:scale-[0.98] text-white font-bold tracking-wider transition-all cursor-pointer shadow-lg hover:shadow-brand-accent/25"
      >
        BROADCAST SIGNAL
      </button>
      <button
        type="button"
        id="delete-current-btn"
        class="hidden px-6 py-4 rounded-xl bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 font-bold tracking-wider transition-colors"
      >
        <span class="i-heroicons-trash w-5 h-5"></span>
      </button>
    </div>

    <div id="status" class="hidden p-4 rounded-xl text-center text-sm"></div>
  </div>

  <!-- Success Modal Overlay -->
  <div
    id="success-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 pointer-events-none"
  >
    <div class="relative w-full max-w-lg flex flex-col items-center">
      <!-- Glitch/Success Effect (Like 404) -->
      <div
        class="relative mb-8 transform scale-90 md:scale-100 transition-transform duration-300 delay-100 pointer-events-none"
      >
        <h1
          class="text-9xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-white/10 opacity-20 select-none"
        >
          200
        </h1>
        <div class="absolute inset-0 flex items-center justify-center">
          <h2
            class="text-4xl md:text-5xl font-bold font-display text-green-400 drop-shadow-[0_0_15px_rgba(74,222,128,0.5)] animate-pulse flex items-center justify-center gap-3 whitespace-nowrap"
          >
            <span class="i-heroicons-check-circle text-5xl"></span>
            <span>Signal Live!</span>
          </h2>
        </div>
      </div>

      <div
        class="glass-panel p-8 md:p-12 rounded-3xl w-full text-center transform scale-95 transition-transform duration-300 border border-white/10 shadow-2xl"
      >
        <p class="text-xl md:text-2xl font-medium text-white mb-4">
          Transmission Successful
        </p>
        <p class="text-gray-400 font-mono text-sm leading-relaxed mb-8">
          The signal has been injected into the network stream.<br />
          All systems operational.
        </p>

        <div class="flex flex-col gap-4 items-center w-full">
          <a
            id="verify-signal-btn"
            href="#"
            target="_blank"
            class="group relative w-full py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-accent hover:opacity-90 text-white font-bold transition-all flex items-center justify-center gap-2 overflow-hidden shadow-[0_0_20px_rgba(139,92,246,0.3)] hover:shadow-[0_0_30px_rgba(139,92,246,0.5)]"
          >
            <div
              class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"
            >
            </div>
            <span class="relative z-10">Verify Signal</span>
            <span
              class="i-heroicons-arrow-top-right-on-square w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform"
            ></span>
          </a>

          <button
            id="return-uplink-btn"
            class="group relative w-full py-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 text-gray-400 hover:text-white transition-all flex items-center justify-center gap-2"
          >
            <span
              class="i-heroicons-arrow-path w-5 h-5 group-hover:-rotate-180 transition-transform duration-500"
            ></span>
            <span>Return to Uplink</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Active Network Sessions Modal -->
  <div
    id="active-sessions-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-all duration-300 pointer-events-none"
  >
    <div
      class="glass-panel w-full max-w-6xl max-h-[85vh] flex flex-col rounded-3xl overflow-hidden border border-white/10 shadow-2xl relative transform scale-95 transition-all duration-300"
    >
      <!-- Close Button -->
      <button
        class="close-inspect-btn absolute top-4 right-4 w-6 h-6 flex items-center justify-center rounded-full bg-red-500/10 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-all duration-200 z-20"
      >
        <span class="i-heroicons-x-mark w-6 h-6"></span>
      </button>

      <!-- Header -->
      <div
        class="p-6 border-b border-white/10 bg-black/40 flex justify-between items-center"
      >
        <div class="flex items-center gap-3">
          <span class="i-heroicons-globe-alt w-6 h-6 text-green-400"></span>
          <h2 class="text-xl font-bold font-display">
            Active Network Sessions
          </h2>
        </div>

        <!-- Logout All Button -->
        <button
          id="logout-all-btn"
          class="mr-12 px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 text-sm font-bold flex items-center gap-2 transition-all"
        >
          <span class="i-heroicons-power w-4 h-4"></span>
          Logout All Users
        </button>
      </div>

      <!-- Content -->
      <div
        class="overflow-y-auto p-0 scrollbar-hide flex-1 bg-black/20 relative"
      >
        <div
          class="p-6 bg-brand-primary/5 border-b border-white/5 text-sm text-gray-400 font-mono"
        >
          Monitoring <span class="text-white font-bold"
            >{(activeSessionsList.results || []).length}</span
          > active connections
        </div>
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-black/95 backdrop-blur-xl z-10">
            <tr
              class="text-gray-400 text-xs uppercase tracking-wider font-mono border-b border-white/10"
            >
              <th class="p-6 font-normal">User</th>
              <th class="p-6 font-normal">Network & ISP</th>
              <th class="p-6 font-normal">Location</th>
              <th class="p-6 font-normal">Connection</th>
              <th class="p-6 font-normal text-right">Status</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-white/5">
            {
              (activeSessionsList.results || []).map((s: any) => {
                const trustScore = s.client_trust_score;
                const isLowTrust = trustScore && trustScore < 30;
                const rtt = s.client_tcp_rtt;
                const rttClass = rtt
                  ? rtt < 50
                    ? "text-green-400"
                    : rtt < 150
                      ? "text-yellow-400"
                      : "text-red-400"
                  : "text-gray-500";

                return (
                  <tr class="hover:bg-white/5 transition-colors">
                    <td class="p-6">
                      <div class="flex items-center gap-3">
                        <img
                          src={
                            s.avatar ||
                            `https://ui-avatars.com/api/?name=${s.username || "?"}&background=random`
                          }
                          class="w-10 h-10 rounded-full border border-white/10"
                        />
                        <div>
                          <div class="font-bold text-white flex items-center gap-2">
                            {s.username || "Unknown"}
                            {isLowTrust && (
                              <span class="px-2 py-0.5 rounded text-[10px] bg-red-500/20 border border-red-500/40 text-red-300 uppercase tracking-wide font-bold">
                                VPN?
                              </span>
                            )}
                          </div>
                          <div class="text-xs text-gray-500 font-mono">
                            SID: {s.session_id.substring(0, 8)}
                          </div>
                          <!-- Client-side UA Parsed Info -->
                          <div class="ua-parser-container mt-1 text-xs" data-ua={s.user_agent}></div>
                        </div>
                      </div>
                    </td>

                    <td class="p-6">
                      <div class="space-y-2">
                        {/* IP Address */}
                        <div class="font-mono text-xs text-brand-accent bg-brand-accent/10 px-2 py-1 rounded inline-block border border-brand-accent/20">
                          {s.ip_address || "Hidden"}
                        </div>

                        {/* ISP & AS Organization */}
                        {s.as_organization && (
                          <div class="text-xs text-white flex items-center gap-1">
                            <span class="i-heroicons-building-office-2 w-3 h-3 text-purple-400" />
                            <span>{s.as_organization}</span>
                            {s.asn && (
                              <span class="text-gray-500 ml-1">
                                (AS{s.asn})
                              </span>
                            )}
                          </div>
                        )}

                        {/* Edge Node */}
                        {s.colo && (
                          <div class="text-xs text-gray-400 flex items-center gap-1">
                            <span class="i-heroicons-server w-3 h-3" />
                            <span>Edge: {s.colo}</span>
                          </div>
                        )}
                      </div>
                    </td>

                    <td class="p-6">
                      <div class="space-y-1 text-xs">
                        {/* Country & City */}
                        <div class="text-white font-medium flex items-center gap-1">
                          <span class="i-heroicons-map-pin w-3 h-3 text-green-400" />
                          {s.country || "??"} {s.city && `â€¢ ${s.city}`}
                        </div>

                        {/* Region */}
                        {s.region && (
                          <div class="text-gray-400">
                            {s.region} {s.region_code && `(${s.region_code})`}
                          </div>
                        )}

                        {/* Timezone */}
                        {s.timezone && (
                          <div class="text-gray-500 flex items-center gap-1">
                            <span class="i-heroicons-clock w-3 h-3" />
                            {s.timezone}
                          </div>
                        )}

                        {/* Lat/Long (collapsed, monospace) */}
                        {s.latitude && s.longitude && (
                          <div class="text-gray-600 font-mono text-[10px]">
                            {s.latitude}, {s.longitude}
                          </div>
                        )}
                      </div>
                    </td>

                    <td class="p-6">
                      <div class="space-y-1.5 text-xs">
                        {/* HTTP Protocol */}
                        {s.http_protocol && (
                          <div class="flex items-center gap-1.5">
                            <span class="i-heroicons-signal w-3 h-3 text-blue-400" />
                            <span class="text-white font-medium">
                              {s.http_protocol}
                            </span>
                          </div>
                        )}

                        {/* TLS Version */}
                        {s.tls_version && (
                          <div class="flex items-center gap-1.5">
                            <span class="i-heroicons-lock-closed w-3 h-3 text-green-400" />
                            <span class="text-gray-400">{s.tls_version}</span>
                          </div>
                        )}

                        {/* RTT */}
                        {rtt && (
                          <div class={`flex items-center gap-1.5 ${rttClass}`}>
                            <span class="i-heroicons-bolt w-3 h-3" />
                            <span>{rtt}ms</span>
                          </div>
                        )}

                        {/* Trust Score */}
                        {trustScore && (
                          <div class="text-gray-500 font-mono text-[10px]">
                            Trust: {trustScore}/99
                          </div>
                        )}

                        {/* Device Intelligence */}
                        {(s.screen_resolution ||
                          s.device_memory ||
                          s.cpu_cores) && (
                          <div class="pt-2 mt-2 border-t border-white/5 space-y-1">
                            {s.screen_resolution && (
                              <div class="flex items-center gap-1.5 text-gray-400">
                                <span class="i-heroicons-computer-desktop w-3 h-3" />
                                <span>{s.screen_resolution}</span>
                              </div>
                            )}
                            <div class="flex items-center gap-2 text-gray-500 font-mono text-[10px]">
                              {s.cpu_cores && <span>{s.cpu_cores} Cores</span>}
                              {s.device_memory && (
                                <span>{s.device_memory}GB RAM</span>
                              )}
                              {s.connection_type && (
                                <span class="uppercase border border-white/10 px-1 rounded">
                                  {s.connection_type}
                                </span>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </td>

                    <td class="p-6 text-right">
                      <div class="text-white font-mono text-sm">
                        {s.last_active
                          ? new Date(s.last_active).toLocaleTimeString()
                          : "N/A"}
                      </div>
                      <div class="text-xs text-gray-500 mt-1">
                        Since:{" "}
                        {s.session_created
                          ? new Date(s.session_created).toLocaleDateString()
                          : "?"}
                      </div>
                    </td>
                  </tr>
                );
              })
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- User Database Modal -->
  <div
    id="user-database-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-all duration-300 pointer-events-none"
  >
    <div
      class="glass-panel w-full max-w-6xl max-h-[85vh] flex flex-col rounded-3xl overflow-hidden border border-white/10 shadow-2xl relative transform scale-95 transition-all duration-300"
    >
      <!-- Close Button -->
      <button
        class="close-inspect-btn absolute top-4 right-4 w-6 h-6 flex items-center justify-center rounded-full bg-red-500/10 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-all duration-200 z-20"
      >
        <span class="i-heroicons-x-mark w-6 h-6"></span>
      </button>

      <!-- Header -->
      <div
        class="p-6 border-b border-white/10 bg-black/40 flex items-center gap-3"
      >
        <span class="i-heroicons-users w-6 h-6 text-brand-accent"></span>
        <h2 class="text-xl font-bold font-display">User Database</h2>
      </div>

      <!-- Content -->
      <div
        class="overflow-y-auto p-0 scrollbar-hide flex-1 bg-black/20 relative"
      >
        <div
          class="p-6 bg-brand-accent/5 border-b border-white/5 text-sm text-gray-400 font-mono"
        >
          Found <span class="text-white font-bold"
            >{(usersList.results || []).length}</span
          > records (showing latest 100)
        </div>
        <table class="w-full text-left border-collapse">
          <thead
            class="sticky top-0 bg-black/95 backdrop-blur-xl z-10 box-decoration-clone"
          >
            <tr
              class="text-gray-400 text-xs uppercase tracking-wider font-mono border-b border-white/10"
            >
              <th class="p-6 font-normal">User</th>
              <th class="p-6 font-normal">Identity Provider</th>
              <th class="p-6 font-normal">IDs</th>
              <th class="p-6 font-normal">Last Seen</th>
              <th class="p-6 font-normal text-right">Joined</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-white/5">
            {
              (usersList.results || []).map((u: any) => (
                <tr class="hover:bg-white/5 transition-colors">
                  <td class="p-6">
                    <div class="flex items-center gap-3">
                      <img
                        src={
                          u.avatar ||
                          `https://ui-avatars.com/api/?name=${u.username}&background=random`
                        }
                        class="w-10 h-10 rounded-full object-cover border border-white/10"
                      />
                      <div>
                        <div class="font-bold text-white mb-0.5">
                          {u.username}
                        </div>
                        <div class="text-xs text-brand-accent/80 font-mono">
                          {u.id.substring(0, 8)}...
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="p-6">
                    <div class="flex gap-2">
                      {u.github_id && (
                        <span class="px-2 py-1 rounded bg-[#24292e]/50 border border-[#24292e]/50 text-xs text-gray-300 flex items-center gap-1">
                          <span class="i-simple-icons-github" /> GitHub
                        </span>
                      )}
                      {u.google_id && (
                        <span class="px-2 py-1 rounded bg-[#DB4437]/20 border border-[#DB4437]/30 text-xs text-red-200 flex items-center gap-1">
                          <span class="i-simple-icons-google" /> Google
                        </span>
                      )}
                      {u.discord_id && (
                        <span class="px-2 py-1 rounded bg-[#5865F2]/20 border border-[#5865F2]/30 text-xs text-indigo-200 flex items-center gap-1">
                          <span class="i-simple-icons-discord" /> Discord
                        </span>
                      )}
                    </div>
                  </td>
                  <td class="p-6 font-mono text-xs text-gray-500 space-y-1">
                    {u.github_username && (
                      <div class="flex items-center gap-2">
                        <span class="i-simple-icons-github w-4 h-4" />
                        <span>{u.github_username}</span>
                      </div>
                    )}
                    {u.google_username && (
                      <div class="flex items-center gap-2">
                        <span class="i-simple-icons-google w-4 h-4" />
                        <span>{u.google_username}</span>
                      </div>
                    )}
                    {u.discord_username && (
                      <div class="flex items-center gap-2">
                        <span class="i-simple-icons-discord w-4 h-4" />
                        <span>{u.discord_username}</span>
                      </div>
                    )}
                  </td>
                  <td class="p-6">
                    <div class="space-y-2">
                      {u.last_active ? (
                        <>
                          <div class="space-y-1 border-b border-white/5 pb-2 mb-2">
                            <div class="text-white font-medium text-xs">
                              {new Date(u.last_active).toLocaleString("en-SG", {
                                timeZone: "Asia/Singapore",
                              })}
                            </div>
                            <div class="text-xs text-gray-400 flex items-center gap-1.5">
                               <span class="i-heroicons-map-pin w-3 h-3 text-brand-accent"></span>
                               <span>{u.city || "?"}, {u.country || "?"}</span>
                            </div>
                            <div class="text-[10px] font-mono text-gray-500 bg-white/5 px-1.5 py-0.5 rounded inline-block">
                              {u.ip_address || "Hidden IP"}
                            </div>
                             {u.as_organization && (
                              <div class="text-[10px] text-gray-500 truncate max-w-[150px]" title={u.as_organization}>
                                {u.as_organization}
                              </div>
                            )}
                          </div>
                          
                          {/* Rich Device Info */}
                          <div>
                             {/* Client-side UA Parsed Info */}
                             <div class="ua-parser-container text-[10px]" data-ua={u.user_agent}></div>
                             
                             {(u.screen_resolution || u.device_memory || u.connection_type) && (
                              <div class="flex flex-wrap gap-1 mt-1 text-[10px] text-gray-500 font-mono">
                                {u.screen_resolution && <span>{u.screen_resolution}</span>}
                                {u.device_memory && <span>{u.device_memory}GB</span>}
                                {u.connection_type && <span class="uppercase border border-white/10 px-1 rounded">{u.connection_type}</span>}
                              </div>
                             )}
                          </div>
                        </>
                      ) : (
                        <span class="text-xs text-gray-600 italic">Never</span>
                      )}
                    </div>
                  </td>
                  <td class="p-6 text-right text-gray-400 font-mono text-xs">
                    {(() => {
                      const allowedOwners = ["ichimarugin", "ichimarugin728", "gin ichimaru"];
                      const isOwner = 
                        (u.github_username && allowedOwners.includes(u.github_username.toLowerCase())) ||
                        (u.google_username && allowedOwners.includes(u.google_username.toLowerCase())) ||
                        (u.discord_username && allowedOwners.includes(u.discord_username.toLowerCase()));
                      
                      if (isOwner) {
                        return <span class="text-brand-accent font-bold px-2 py-0.5 rounded bg-brand-accent/10 border border-brand-accent/20">ðŸ‘‘ Creator</span>;
                      }
                      
                      if (u.created_at) {
                        return new Date(
                          typeof u.created_at === "number"
                            ? u.created_at
                            : parseInt(u.created_at) || 0,
                        ).toLocaleString("en-SG", {
                          timeZone: "Asia/Singapore",
                          dateStyle: "medium",
                        });
                      }
                      
                      return <span class="opacity-50">Jan 31, 2026</span>;
                    })()}
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edge Analytics Modal -->
  <div
    id="edge-analytics-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 pointer-events-none"
  >
    <div
      class="glass-panel p-0 rounded-3xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col scale-95 transition-transform duration-300 relative"
    >
      <!-- Close Button (Consistent with other modals) -->
      <button
        class="close-inspect-btn absolute top-4 right-4 w-6 h-6 flex items-center justify-center rounded-full bg-red-500/10 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-all duration-200 z-20"
      >
        <span class="i-heroicons-x-mark w-6 h-6"></span>
      </button>

      <!-- Header -->
      <div class="p-6 border-b border-white/10 bg-black/40">
        <h2 class="text-3xl font-display font-bold flex items-center gap-3">
          <span class="i-heroicons-server w-8 h-8 text-blue-400"></span>
          Edge Analytics
        </h2>
        <p class="text-gray-400 mt-1">Cloudflare node distribution & routing</p>
      </div>

      <!-- Content -->
      <div class="overflow-y-auto p-6 scrollbar-hide flex-1 bg-black/20">
        <div class="grid grid-cols-4 gap-4 mb-8">
          <div class="glass-panel p-4 rounded-xl">
            <div class="text-xs text-gray-400 mb-1">Active Nodes</div>
            <div class="text-2xl font-bold text-blue-400">
              {performanceSummary?.active_nodes || 0}
            </div>
          </div>
          <div class="glass-panel p-4 rounded-xl">
            <div class="text-xs text-gray-400 mb-1">Avg RTT</div>
            <div class="text-2xl font-bold text-green-400">
              {Math.round(Number(performanceSummary?.global_avg_rtt || 0))}ms
            </div>
          </div>
          <div class="glass-panel p-4 rounded-xl">
            <div class="text-xs text-gray-400 mb-1">Min RTT</div>
            <div class="text-2xl font-bold text-green-300">
              {Math.round(Number(performanceSummary?.min_rtt || 0))}ms
            </div>
          </div>
          <div class="glass-panel p-4 rounded-xl">
            <div class="text-xs text-gray-400 mb-1">Max RTT</div>
            <div class="text-2xl font-bold text-orange-400">
              {Math.round(Number(performanceSummary?.max_rtt || 0))}ms
            </div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="border-b border-white/10">
              <tr
                class="text-left text-xs uppercase tracking-wider text-gray-400"
              >
                <th class="p-4">Node</th>
                <th class="p-4">Location</th>
                <th class="p-4 text-right">Sessions</th>
                <th class="p-4 text-right">Avg RTT</th>
                <th class="p-4 text-right">Performance</th>
              </tr>
            </thead>
            <tbody class="text-sm divide-y divide-white/5">
              {
                (edgeNodeStats.results || []).map((node: any) => {
                  const location = COLO_LOCATIONS[node.colo] || {
                    city: node.colo,
                    country: "??",
                    flag: "ðŸŒ",
                    region: "",
                  };
                  const avgRtt = Math.round(node.avg_rtt || 0);
                  const rttColor =
                    avgRtt < 50
                      ? "text-green-400"
                      : avgRtt < 150
                        ? "text-yellow-400"
                        : "text-red-400";
                  const percentage = (
                    (node.session_count / (activeSessionCount ?? 1)) *
                    100
                  ).toFixed(1);

                  return (
                    <tr class="hover:bg-white/5 transition-colors">
                      <td class="p-4">
                        <div class="font-mono font-bold text-blue-400">
                          {node.colo}
                        </div>
                      </td>
                      <td class="p-4">
                        <div class="flex items-center gap-2">
                          <span class="text-2xl">{location.flag}</span>
                          <div>
                            <div class="font-semibold">{location.city}</div>
                            <div class="text-xs text-gray-500">
                              {location.region}, {location.country}
                            </div>
                          </div>
                        </div>
                      </td>
                      <td class="p-4 text-right">
                        <div class="font-bold">{node.session_count}</div>
                        <div class="text-xs text-gray-500">{percentage}%</div>
                      </td>
                      <td
                        class={`p-4 text-right font-mono font-bold ${rttColor}`}
                      >
                        {avgRtt}ms
                      </td>
                      <td class="p-4 text-right">
                        {avgRtt < 50 && (
                          <span class="px-2 py-1 rounded bg-green-500/20 text-green-300 text-xs">
                            Excellent
                          </span>
                        )}
                        {avgRtt >= 50 && avgRtt < 150 && (
                          <span class="px-2 py-1 rounded bg-yellow-500/20 text-yellow-300 text-xs">
                            Good
                          </span>
                        )}
                        {avgRtt >= 150 && (
                          <span class="px-2 py-1 rounded bg-red-500/20 text-red-300 text-xs">
                            Poor
                          </span>
                        )}
                      </td>
                    </tr>
                  );
                })
              }
            </tbody>
          </table>
        </div>

        {
          (edgeNodeStats.results || []).some(
            (node: any) => Math.round(node.avg_rtt || 0) > 150,
          ) && (
            <div class="mt-6 p-4 rounded-xl bg-orange-500/10 border border-orange-500/30">
              <div class="flex items-start gap-3">
                <span class="i-heroicons-exclamation-triangle w-6 h-6 text-orange-400 flex-shrink-0 mt-0.5" />
                <div>
                  <div class="font-bold text-orange-300 mb-1">
                    Routing Anomalies Detected
                  </div>
                  <div class="text-sm text-gray-300">
                    High latency detected (&gt;150ms). Possible causes:
                    suboptimal routing, VPN usage, or network congestion.
                  </div>
                </div>
              </div>
            </div>
          )
        }
      </div>
    </div>
  </div>

  <script>
    import { hc } from "hono/client";
    import type { AppType } from "../../api/[...path]";
    import { UAParser } from "ua-parser-js";

    // Initialize UA Parser for all sessions
    // Initialize UA Parser lazily using IntersectionObserver
    const uaObserver = new IntersectionObserver(
      (entries, observer) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const el = entry.target as HTMLElement;
            const ua = el.dataset.ua;
            
            if (ua) {
              // Parse immediately
              const parser = new UAParser(ua);
              const result = parser.getResult();
              
              // Helper for OS Icons
              let osIcon = "i-heroicons-cpu-chip";
              const osName = result.os.name?.toLowerCase() || "";
              if (osName.includes("mac") || osName.includes("ios")) osIcon = "i-simple-icons-apple";
              else if (osName.includes("win")) osIcon = "i-simple-icons-windows";
              else if (osName.includes("android")) osIcon = "i-simple-icons-android";
              else if (osName.includes("linux")) osIcon = "i-simple-icons-linux";
              else if (osName.includes("ubuntu")) osIcon = "i-simple-icons-ubuntu";
              
              // Helper for Browser Icons
              let browserIcon = "i-heroicons-globe-alt";
              const browserName = result.browser.name?.toLowerCase() || "";
              if (browserName.includes("chrome")) browserIcon = "i-simple-icons-googlechrome";
              else if (browserName.includes("safari")) browserIcon = "i-simple-icons-safari";
              else if (browserName.includes("firefox")) browserIcon = "i-simple-icons-firefox";
              else if (browserName.includes("edge")) browserIcon = "i-simple-icons-microsoftedge";
              else if (browserName.includes("opera")) browserIcon = "i-simple-icons-opera";

              // Render Content
              el.innerHTML = `
                <div class="flex flex-col gap-1 select-none animate-fade-in">
                  <div class="flex items-center gap-1.5 text-gray-200">
                    <span class="${osIcon} w-3 h-3 text-gray-400"></span>
                    <span class="font-bold text-[10px]">${result.os.name || "Unknown OS"} ${result.os.version || ""}</span>
                  </div>
                  <div class="flex items-center gap-1.5 text-gray-400">
                     <span class="${browserIcon} w-3 h-3"></span>
                     <span class="text-[10px]">${result.browser.name || "Unknown Browser"} ${result.browser.version || ""}</span>
                  </div>
                  ${result.device.type || result.device.model ? 
                    `<div class="flex items-center gap-1 mt-0.5">
                       <span class="i-heroicons-device-phone-mobile w-3 h-3 text-gray-500"></span>
                       <div class="text-[10px] text-gray-500 font-mono border border-white/10 px-1 rounded bg-white/5">
                         ${result.device.vendor || ""} ${result.device.model || "Generic Device"}
                       </div>
                     </div>` 
                    : ""}
                </div>
              `;
            }
            
            // Stop observing this element
            observer.unobserve(el);
          }
        });
      },
      { rootMargin: "50px" } // Preload when getting close
    );

    document.querySelectorAll(".ua-parser-container").forEach((el) => {
      uaObserver.observe(el);
    });

    // No-op for compatibility if referenced elsewhere, or remove entirely if safe.
    // Legacy fetchGeoData removed as per user request to rely on DB data.

    // Tab Switcher Logic
    // @ts-ignore
    // --- Modals Logic ---
    const activeSessionsModal = document.getElementById(
      "active-sessions-modal",
    );
    const userDatabaseModal = document.getElementById("user-database-modal");
    const edgeAnalyticsModal = document.getElementById("edge-analytics-modal");

    const closeModals = () => {
      activeSessionsModal?.classList.add("opacity-0");
      userDatabaseModal?.classList.add("opacity-0");
      edgeAnalyticsModal?.classList.add("opacity-0");
      setTimeout(() => {
        activeSessionsModal?.classList.add("hidden", "pointer-events-none");
        userDatabaseModal?.classList.add("hidden", "pointer-events-none");
        edgeAnalyticsModal?.classList.add("hidden", "pointer-events-none");
      }, 300);
      activeSessionsModal
        ?.querySelector(".glass-panel")
        ?.classList.remove("scale-100");
      activeSessionsModal
        ?.querySelector(".glass-panel")
        ?.classList.add("scale-95");
      userDatabaseModal
        ?.querySelector(".glass-panel")
        ?.classList.remove("scale-100");
      userDatabaseModal
        ?.querySelector(".glass-panel")
        ?.classList.add("scale-95");
      edgeAnalyticsModal
        ?.querySelector(".glass-panel")
        ?.classList.remove("scale-100");
      edgeAnalyticsModal
        ?.querySelector(".glass-panel")
        ?.classList.add("scale-95");
    };

    document.querySelectorAll(".close-inspect-btn").forEach((btn) => {
      btn.addEventListener("click", closeModals);
    });

    // Close on backdrop click (all modals)
    activeSessionsModal?.addEventListener("click", (e) => {
      if (e.target === activeSessionsModal) closeModals();
    });
    userDatabaseModal?.addEventListener("click", (e) => {
      if (e.target === userDatabaseModal) closeModals();
    });
    edgeAnalyticsModal?.addEventListener("click", (e) => {
      if (e.target === edgeAnalyticsModal) closeModals();
    });

    // Open Handlers
    // @ts-ignore
    window.openInspector = (type) => {
      if (type === "sessions") {
        activeSessionsModal?.classList.remove("hidden", "pointer-events-none");
        void activeSessionsModal?.offsetWidth;
        activeSessionsModal?.classList.remove("opacity-0");
        activeSessionsModal
          ?.querySelector(".glass-panel")
          ?.classList.remove("scale-95");
        activeSessionsModal
          ?.querySelector(".glass-panel")
          ?.classList.add("scale-100");
      } else if (type === "edge") {
        edgeAnalyticsModal?.classList.remove("hidden", "pointer-events-none");
        void edgeAnalyticsModal?.offsetWidth;
        edgeAnalyticsModal?.classList.remove("opacity-0");
        edgeAnalyticsModal
          ?.querySelector(".glass-panel")
          ?.classList.remove("scale-95");
        edgeAnalyticsModal
          ?.querySelector(".glass-panel")
          ?.classList.add("scale-100");
      } else {
        userDatabaseModal?.classList.remove("hidden", "pointer-events-none");
        void userDatabaseModal?.offsetWidth;
        userDatabaseModal?.classList.remove("opacity-0");
        userDatabaseModal
          ?.querySelector(".glass-panel")
          ?.classList.remove("scale-95");
        userDatabaseModal
          ?.querySelector(".glass-panel")
          ?.classList.add("scale-100");
      }
    };

    // Logout All Users Logic
    const logoutAllBtn = document.getElementById("logout-all-btn");
    logoutAllBtn?.addEventListener("click", async () => {
      const confirmed = confirm(
        "CRITICAL: This will log out every active user (including you if you are using a session). Are you sure?",
      );
      if (!confirmed) return;

      logoutAllBtn.innerText = "Terminating...";
      (logoutAllBtn as HTMLButtonElement).disabled = true;

      try {
        const res = await fetch("/api/admin/sessions", {
          method: "DELETE",
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const responseText = await res.text();
        console.log("Logout All Response:", res.status, responseText);

        if (res.ok) {
          alert("All sessions terminated. The grid will now reboot.");
          window.location.reload();
        } else {
          let errorMsg = `Failed (${res.status})`;
          try {
            const errorData = JSON.parse(responseText);
            errorMsg = errorData.error || errorData.message || responseText;
          } catch (e) {
            console.error("Failed to parse error response:", e);
          }
          alert(`Failed to terminate sessions: ${errorMsg}`);
        }
        logoutAllBtn.innerHTML =
          '<span class="i-heroicons-power w-4 h-4"></span> Logout All Users';
        (logoutAllBtn as HTMLButtonElement).disabled = false;
      } catch (e) {
        console.error(e);
        alert("Network Error");
        logoutAllBtn.innerHTML =
          '<span class="i-heroicons-power w-4 h-4"></span> Logout All Users';
        (logoutAllBtn as HTMLButtonElement).disabled = false;
      }
    });

    const client = hc<AppType>(window.location.origin) as any;
    const form = document.getElementById("create-post-form") as HTMLFormElement;

    // Bind Edit Buttons (Recent List)
    const bindActionButtons = () => {
      document.querySelectorAll(".edit-post-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const slug = (e.currentTarget as HTMLElement).dataset.slug;
          if (slug) {
            loadPostForEdit(slug);
          }
        });
      });

      document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const target = e.currentTarget as HTMLElement;
          const slug = target.dataset.slug;
          const currentStatus = target.dataset.status;
          const action =
            currentStatus === "published" ? "unpublish" : "publish";

          if (!confirm(`Are you sure you want to ${action} this signal?`))
            return;

          try {
            const res = await fetch(`/api/posts/${slug}/status`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ action }),
            });
            if (res.ok) {
              window.location.reload(); // Refresh to show status change
            } else {
              alert("Failed to update status");
            }
          } catch (err) {
            console.error(err);
          }
        });
      });

      document.querySelectorAll(".delete-post-btn").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          const slug = (e.currentTarget as HTMLElement).dataset.slug;
          if (
            !confirm(
              "WARNING: This will permanently delete the signal. Proceed?",
            )
          )
            return;

          try {
            const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
            if (res.ok) {
              window.location.reload();
            } else {
              alert("Failed to delete signal");
            }
          } catch (err) {
            console.error(err);
          }
        });
      });
    };

    bindActionButtons();

    // Ensure fresh state on navigation (fix BFCache)
    window.addEventListener("pageshow", () => {
      form.reset();
      document.getElementById("post-id")?.setAttribute("value", "");
      // Reset button text
      const btn = document.querySelector('button[type="submit"]');
      if (btn) btn.innerHTML = "BROADCAST SIGNAL";
    });
    const status = document.getElementById("status");
    const fileInput = document.getElementById("file-input") as HTMLInputElement;
    const uploadBtn = document.getElementById("upload-btn");
    const autoUpdateToggle = document.getElementById(
      "auto-update-toggle",
    ) as HTMLInputElement;
    const updatedAtInput = document.getElementById(
      "updated-at-input",
    ) as HTMLInputElement;

    autoUpdateToggle?.addEventListener("change", () => {
      updatedAtInput.disabled = autoUpdateToggle.checked;
      if (autoUpdateToggle.checked) {
        updatedAtInput.value = "";
      } else {
        // Set current time as default when unlocking
        const now = new Date();
        updatedAtInput.value = new Date(
          now.getTime() - now.getTimezoneOffset() * 60000,
        )
          .toISOString()
          .slice(0, 16);
      }
    });
    // @ts-ignore
    const textarea = document.getElementById(
      "content-area",
    ) as HTMLTextAreaElement;

    // File Upload Handler
    uploadBtn?.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", async (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      uploadBtn!.innerText = "Uploading...";

      try {
        const res = await fetch(
          `/api/upload?filename=${encodeURIComponent(file.name)}`,
          {
            method: "PUT",
            body: file,
          },
        );

        if (res.ok) {
          const data = (await res.json()) as any;
          // Insert Markdown Image syntax
          const cursorPosition = textarea.selectionStart;
          const textBefore = textarea.value.substring(0, cursorPosition);
          const textAfter = textarea.value.substring(
            cursorPosition,
            textarea.value.length,
          );
          const imageMarkdown = `\n![${file.name}](${data.url})\n`;

          textarea.value = textBefore + imageMarkdown + textAfter;
          uploadBtn!.innerHTML =
            '<span class="i-heroicons-check"></span> Uploaded';
          setTimeout(() => {
            uploadBtn!.innerHTML =
              '<span class="i-heroicons-photo"></span> Upload Media';
          }, 2000);
        }
      } catch (err) {
        console.error(err);
        uploadBtn!.innerText = "Failed";
      }
    });

    // Quick Publish Logic
    const quickPublishBtn = document.getElementById("quick-publish-btn");
    const quickPublishFile = document.getElementById(
      "quick-publish-file",
    ) as HTMLInputElement;
    const quickPublishStatus = document.getElementById("quick-publish-status");

    quickPublishBtn?.addEventListener("click", async () => {
      const file = quickPublishFile?.files?.[0];
      if (!file) {
        alert("Please select a file first.");
        return;
      }

      if (!confirm(`Ready to broadcast ${file.name}?`)) return;

      quickPublishBtn.innerHTML =
        '<span class="animate-spin i-heroicons-arrow-path"></span> Broadcasting...';
      (quickPublishBtn as HTMLButtonElement).disabled = true;
      quickPublishStatus!.classList.add("hidden");

      const formData = new FormData();
      formData.append("file", file);

      try {
        const res = await fetch("/api/posts/upload", {
          method: "POST",
          body: formData,
        });

        const result = (await res.json()) as any;

        if (res.ok) {
          quickPublishStatus!.innerHTML = `<span class="text-green-400">âœ“ Signal Live: <a href="/blog/${result.slug}" target="_blank" class="underline hover:text-white">${result.slug}</a></span>`;
          quickPublishStatus!.classList.remove("hidden");
          quickPublishFile.value = "";

          // Reload list after short delay
          setTimeout(() => window.location.reload(), 1500);
        } else {
          throw new Error(result.error || "Upload failed");
        }
      } catch (e: any) {
        console.error(e);
        quickPublishStatus!.innerHTML = `<span class="text-red-400">âš  Transmission Error: ${e.message}</span>`;
        quickPublishStatus!.classList.remove("hidden");
      } finally {
        quickPublishBtn.innerHTML =
          '<span class="i-heroicons-paper-airplane"></span> Publish';
        (quickPublishBtn as HTMLButtonElement).disabled = false;
      }
    });

    // Post Submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      status!.className = "hidden p-4 rounded-xl text-center text-sm";

      // Validation Check
      if (!formData.get("title") || !formData.get("slug")) {
        alert("Missing Critical Data: Title or Slug required.");
        return;
      }

      // Verify FormData capture
      console.log("ðŸ“¦ Form Payload:", Object.fromEntries(formData));

      try {
        const res = await client.api.posts.$post({
          form: {
            id: formData.get("id") as string,
            title: formData.get("title") as string,
            slug: formData.get("slug") as string,
            content: formData.get("content") as string,
            publishedAt: formData.get("publishedAt") as string,
            updatedAt: formData.get("updatedAt") as string,
          },
        });

        if (res.ok) {
          const modal = document.getElementById("success-modal");
          const verifyBtn = document.getElementById(
            "verify-signal-btn",
          ) as HTMLAnchorElement;
          // returnBtn removed
          const slug = formData.get("slug") as string;

          if (verifyBtn) verifyBtn.href = `/blog/${slug}`;
          void modal?.offsetWidth;
          modal?.classList.remove("opacity-0");

          // Reset Form
          form.reset();
          textarea.value = "";
          document.getElementById("post-id")?.setAttribute("value", "");
          // Reset button
          const btn = document.querySelector('button[type="submit"]');
          if (btn) btn.innerHTML = "BROADCAST SIGNAL";

          // Optional: Reload list to show new post immediately?
          // For now, let user choose action in modal.
        } else {
          try {
            const data = await res.json();
            alert(`Error: ${data.message || "Unknown error"}`);
          } catch (e) {
            alert("Error: Failed to save post");
          }
        }
      } catch (err) {
        console.error(err);
        alert("Network Error");
      } finally {
        status!.className = "hidden";
      }
    });

    // --- Device Intelligence Collection ---
    const reportDeviceInfo = async () => {
      // Don't report if already done this session (optional, but good for performance)
      if (sessionStorage.getItem("gins_device_reported")) return;

      const info = {
        screenResolution: `${window.screen.width}x${window.screen.height}`,
        // @ts-ignore
        deviceMemory: navigator.deviceMemory,
        cpuCores: navigator.hardwareConcurrency,
        // @ts-ignore
        connectionType: navigator.connection?.effectiveType,
      };

      try {
        await fetch("/api/session/device-info", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(info),
        });
        sessionStorage.setItem("gins_device_reported", "true");
        console.log("ðŸ“¡ Device Intelligence Reported:", info);
      } catch (e) {
        console.error("Device info report failed", e);
      }
    };

    // Report on load
    reportDeviceInfo();

    // Handle Delete from Editor
    const deleteCurrentBtn = document.getElementById("delete-current-btn");
    deleteCurrentBtn?.addEventListener("click", async () => {
      const slug = (document.getElementById("slug-input") as HTMLInputElement)
        .value;
      if (!slug) return;

      if (
        !confirm(
          "CRITICAL WARNING: This will permanently purge this signal from the database. This action is irreversible. Proceed?",
        )
      )
        return;

      try {
        const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
        if (res.ok) {
          window.location.reload();
        } else {
          alert("Failed to delete signal");
        }
      } catch (err) {
        console.error(err);
        alert("Network Error");
      }
    });

    // --- Global Search Logic ---
    const searchInput = document.getElementById(
      "admin-search-input",
    ) as HTMLInputElement;
    const resultsContainer = document.getElementById("admin-search-results");
    let debounceTimer: ReturnType<typeof setTimeout>;

    async function loadPostForEdit(slug: string) {
      try {
        const res = await fetch(`/api/posts/${slug}`);
        if (res.ok) {
          const post = (await res.json()) as any;
          // Populate Form
          (document.getElementById("post-id") as HTMLInputElement).value =
            post.id;
          (document.getElementById("title-input") as HTMLInputElement).value =
            post.title;
          (document.getElementById("slug-input") as HTMLInputElement).value =
            post.slug;
          (
            document.getElementById("content-area") as HTMLTextAreaElement
          ).value = post.content;

          if (post.publishedAt) {
            const date = new Date(post.publishedAt);
            const iso = new Date(
              date.getTime() - date.getTimezoneOffset() * 60000,
            )
              .toISOString()
              .slice(0, 16);
            (
              document.getElementById("published-at-input") as HTMLInputElement
            ).value = iso;
          }

          if (post.updatedAt) {
            const date = new Date(post.updatedAt);
            const iso = new Date(
              date.getTime() - date.getTimezoneOffset() * 60000,
            )
              .toISOString()
              .slice(0, 16);
            updatedAtInput.value = iso;
            autoUpdateToggle.checked = false;
            updatedAtInput.disabled = false;
          } else {
            updatedAtInput.value = "";
            autoUpdateToggle.checked = true;
            updatedAtInput.disabled = true;
          }

          // Scroll to editor
          document
            .getElementById("create-post-form")
            ?.scrollIntoView({ behavior: "smooth" });

          // Update Button Text & Show Delete
          const btn = document.querySelector('button[type="submit"]');
          if (btn) btn.innerHTML = "UPDATE SIGNAL";

          document
            .getElementById("delete-current-btn")
            ?.classList.remove("hidden");
        }
      } catch (e) {
        console.error("Failed to load post", e);
      }
    }

    if (searchInput && resultsContainer) {
      searchInput.addEventListener("input", (e) => {
        const query = (e.target as HTMLInputElement).value;
        clearTimeout(debounceTimer);

        if (query.length < 2) {
          resultsContainer.classList.add("hidden");
          return;
        }

        debounceTimer = setTimeout(async () => {
          try {
            const res = await fetch(
              `/api/search?q=${encodeURIComponent(query)}`,
            );
            const matches = (await res.json()) as any[];

            if (matches.length > 0) {
              resultsContainer.innerHTML = matches
                .map(
                  (match: any) => `
                          <div data-slug="${match.metadata.slug}" class="search-result-item block p-3 hover:bg-white/10 rounded-xl transition-colors cursor-pointer">
                              <div class="font-bold text-white text-sm">${match.metadata.title}</div>
                              <div class="text-xs text-brand-accent mt-1">${(match.score * 100).toFixed(1)}% Match â€¢ Click to Edit</div>
                          </div>
                      `,
                )
                .join("");
              resultsContainer.classList.remove("hidden");

              // Add click listeners to results
              document
                .querySelectorAll(".search-result-item")
                .forEach((item) => {
                  item.addEventListener("click", async (ev) => {
                    const slug = (ev.currentTarget as HTMLElement).dataset.slug;
                    console.log("Loading post:", slug);
                    loadPostForEdit(slug!);
                    resultsContainer.classList.add("hidden");
                  });
                });
            } else {
              resultsContainer.innerHTML =
                '<div class="p-3 text-sm text-gray-500 text-center">No signals found.</div>';
              resultsContainer.classList.remove("hidden");
            }
          } catch (err) {
            console.error(err);
          }
        }, 300);
      });

      // Hide on click outside
      document.addEventListener("click", (e) => {
        if (
          !searchInput.contains(e.target as Node) &&
          !resultsContainer.contains(e.target as Node)
        ) {
          resultsContainer.classList.add("hidden");
        }
      });

      // Load All Archives Logic
      const loadAllBtn = document.getElementById("load-all-signals-btn");
      const tableBody = document.getElementById("signal-log-body");

      loadAllBtn?.addEventListener("click", async () => {
        loadAllBtn.innerText = "Loading Archive...";
        loadAllBtn.setAttribute("disabled", "true");

        try {
          const res = await fetch("/api/posts?limit=all");
          const allPosts = (await res.json()) as any[];

          if (tableBody) {
            tableBody.innerHTML = allPosts
              .map((post) => {
                const isPublished = Date.now() >= (post.publishedAt || 0);
                const dateStr = new Date(
                  post.publishedAt || post.createdAt,
                ).toLocaleDateString();

                return `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                      <td class="py-4">
                        <span class="inline-block w-2 h-2 rounded-full ${isPublished ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]" : "bg-yellow-400"}"></span>
                      </td>
                      <td class="py-4 font-medium text-white">${post.title}</td>
                      <td class="py-4 text-gray-400 font-mono text-xs">${dateStr}</td>
                      <td class="py-4 text-gray-400 font-mono text-xs text-right">
                          <span class="inline-flex items-center gap-1 bg-white/5 px-2 py-1 rounded">
                             <span class="i-heroicons-eye w-3 h-3"></span> ${post.views || 0}
                          </span>
                      </td>
                      <td class="py-4 text-right flex items-center justify-end gap-2">
                        <button class="edit-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-brand-primary/20 text-gray-300 hover:text-brand-accent border border-white/10 hover:border-brand-primary/50 transition-all text-xs" data-slug="${post.slug}" title="Edit Post">
                          <span class="i-heroicons-pencil-square w-4 h-4"></span>
                        </button>
                        <button class="toggle-status-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-gray-300 hover:text-yellow-400 border border-white/10 hover:border-yellow-500/50 transition-all text-xs" data-slug="${post.slug}" data-status="${isPublished ? "published" : "draft"}" title="${isPublished ? "Unpublish (Hide)" : "Publish (Show)"}">
                          <span class="${isPublished ? "i-heroicons-eye-slash w-4 h-4" : "i-heroicons-eye w-4 h-4"}"></span>
                        </button>
                        <button class="delete-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/10 hover:border-red-500/50 transition-all text-xs" data-slug="${post.slug}" title="Delete Post">
                          <span class="i-heroicons-trash w-4 h-4"></span>
                        </button>
                      </td>
                    </tr>
                    `;
              })
              .join("");

            // Re-bind buttons since DOM changed
            bindActionButtons();

            loadAllBtn.classList.add("hidden");
            const countEl = document.getElementById("signal-log-count");
            if (countEl)
              countEl.innerText = `Showing All ${allPosts.length} Signals`;
          }
        } catch (e) {
          console.error(e);
          loadAllBtn.innerText = "Sync Failed";
        }
      });
    }
  </script>
</Layout>
