---
import Layout from "../../../layouts/Layout.astro";

// Protect Route handled by Middleware (Zero Trust)
const env = Astro.locals.runtime.env;

// Helper for safe DB queries
async function safeFetch<T>(promise: Promise<T>, fallback: T): Promise<T> {
  try {
    return await promise;
  } catch (e) {
    console.error("DB Error:", e);
    return fallback;
  }
}

// Analytics Data
const postCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM posts").first<number>("count"),
  0,
);

const userCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM users").first<number>("count"),
  0,
);

const activeSessionCount = await safeFetch(
  env.DB.prepare("SELECT count(*) as count FROM sessions WHERE expires_at > ?")
    .bind(Date.now())
    .first<number>("count"),
  0,
);

// Prevent Caching
Astro.response.headers.set(
  "Cache-Control",
  "no-cache, no-store, must-revalidate",
);
Astro.response.headers.set("Pragma", "no-cache");
Astro.response.headers.set("Expires", "0");
const recentPosts = await safeFetch(
  env.DB.prepare(
    "SELECT * FROM posts ORDER BY published_at DESC LIMIT 10",
  ).all(),
  // @ts-ignore
  { results: [], success: false, meta: {} },
);

// Detailed Lists for Modals
const activeSessionsList = await safeFetch(
  env.DB.prepare(
    `
    SELECT 
      sessions.id as session_id,
      sessions.ip_address, 
      sessions.user_agent, 
      sessions.last_active, 
      sessions.created_at as session_created,
      sessions.city,
      sessions.country,
      users.username, 
      users.avatar,
      users.id as user_id,
      users.github_username,
      users.google_username,
      users.discord_username
    FROM sessions 
    LEFT JOIN users ON sessions.user_id = users.id 
    WHERE sessions.expires_at > ? 
    ORDER BY sessions.last_active DESC
  `,
  )
    .bind(Date.now())
    .all(),
  // @ts-ignore
  { results: [] },
);

const usersList = await safeFetch(
  env.DB.prepare("SELECT * FROM users ORDER BY rowid DESC LIMIT 100").all(), // valid sqlite
  // @ts-ignore
  { results: [] },
);
---

<Layout title="Dashboard - Ichimaru Gin">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header
      class="mb-12 flex flex-col md:flex-row justify-between items-center gap-6"
    >
      <div class="flex items-center gap-8 w-full md:w-auto">
        <div>
          <h1
            class="text-4xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-accent to-brand-primary"
          >
            Analytics Center
          </h1>
          <p class="text-gray-400 mt-2">Real-time data stream.</p>
        </div>

        <!-- Admin Search Box -->
        <div class="hidden md:block relative group flex-1 min-w-[300px] z-20">
          <input
            type="text"
            id="admin-search-input"
            placeholder="Search Global Signals..."
            class="w-full bg-black/40 border border-white/10 rounded-full px-5 py-2.5 focus:outline-none focus:border-brand-accent focus:bg-black/60 transition-all text-white text-sm"
          />
          <div
            id="admin-search-results"
            class="absolute top-full left-0 mt-2 w-full glass-panel rounded-2xl p-2 hidden z-50"
          >
            <!-- Results injected here -->
          </div>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <a
          href="/IchimaruGin728/admin/music"
          class="px-4 py-2 rounded-lg bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 text-purple-300 transition-colors text-sm flex items-center gap-2"
        >
          <span class="i-heroicons-musical-note"></span>
          Music Manager
        </a>
        <a
          href="/"
          class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 transition-colors text-sm"
        >
          Back to Site
        </a>
      </div>
    </header>

    <!-- Analytics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
      <div class="glass-panel p-6 rounded-2xl">
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Total Signals
        </div>
        <div class="text-4xl font-bold font-display">{postCount}</div>
      </div>

      <!-- Users Card (Clickable) -->
      <div
        class="glass-panel p-6 rounded-2xl cursor-pointer hover:bg-white/5 transition-colors group relative"
        onclick="openInspector('users')"
      >
        <div
          class="absolute top-4 right-4 text-gray-500 group-hover:text-white transition-colors"
        >
          <span class="i-heroicons-users w-5 h-5"></span>
        </div>
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Total Users
        </div>
        <div
          class="text-4xl font-bold font-display group-hover:text-brand-accent transition-colors"
        >
          {userCount}
        </div>
        <div
          class="text-xs text-gray-500 mt-2 flex items-center gap-1 group-hover:text-brand-accent/70 transition-colors"
        >
          <span>View Details</span>
          <span class="i-heroicons-arrow-right w-3 h-3"></span>
        </div>
      </div>

      <!-- Sessions Card (Clickable) -->
      <div
        class="glass-panel p-6 rounded-2xl cursor-pointer hover:bg-white/5 transition-colors group relative"
        onclick="openInspector('sessions')"
      >
        <div
          class="absolute top-4 right-4 text-gray-500 group-hover:text-white transition-colors"
        >
          <span class="i-heroicons-globe-alt w-5 h-5"></span>
        </div>
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          Active Sessions
        </div>
        <div
          class="text-4xl font-bold font-display group-hover:text-green-400 transition-colors"
        >
          {activeSessionCount}
        </div>
        <div
          class="text-xs text-gray-500 mt-2 flex items-center gap-1 group-hover:text-green-400/70 transition-colors"
        >
          <span>Inspect Traffic</span>
          <span class="i-heroicons-arrow-right w-3 h-3"></span>
        </div>
      </div>

      <div
        class="glass-panel p-6 rounded-2xl bg-gradient-to-br from-brand-primary/20 to-transparent border-brand-primary/30"
      >
        <div
          class="text-xs font-mono text-gray-400 uppercase tracking-widest mb-2"
        >
          System Status
        </div>
        <div class="flex items-center gap-2 text-green-400 font-bold">
          <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
          OPERATIONAL
        </div>
      </div>
    </div>
  </div>

  <!-- Signal Log List -->
  <div class="glass-panel p-8 rounded-3xl mb-12">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold">Signal Log</h2>
      <div id="signal-log-count" class="text-xs font-mono text-gray-400">
        Showing Recent 10
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left border-collapse" id="signal-log-table">
        <thead>
          <tr
            class="text-gray-400 border-b border-white/10 text-xs uppercase tracking-wider font-mono"
          >
            <th class="py-4 font-normal">Status</th>
            <th class="py-4 font-normal">Title</th>
            <th class="py-4 font-normal">Published</th>
            <th class="py-4 font-normal text-right">Views</th>
            <th class="py-4 font-normal text-right">Action</th>
          </tr>
        </thead>
        <tbody class="text-sm" id="signal-log-body">
          {
            (recentPosts.results || []).map((post: any) => {
              const isPublished = Date.now() >= (post.published_at || 0);
              return (
                <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                  <td class="py-4">
                    <span
                      class={`inline-block w-2 h-2 rounded-full ${isPublished ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]" : "bg-yellow-400"}`}
                    />
                  </td>
                  <td class="py-4 font-medium text-white">{post.title}</td>
                  <td class="py-4 text-gray-400 font-mono text-xs">
                    {new Date(
                      post.published_at || post.created_at,
                    ).toLocaleDateString()}
                  </td>
                  <td class="py-4 text-right">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-white/5 border border-white/10 text-xs font-mono">
                      <span class="i-heroicons-eye w-3 h-3 text-gray-500" />
                      {post.views || 0}
                    </span>
                  </td>
                  <td class="py-4 text-right flex items-center justify-end gap-2">
                    <button
                      class="edit-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-brand-primary/20 text-gray-300 hover:text-brand-accent border border-white/10 hover:border-brand-primary/50 transition-all text-xs"
                      data-slug={post.slug}
                      title="Edit Post"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10"
                        />
                      </svg>
                    </button>
                    <button
                      class="toggle-status-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-gray-300 hover:text-yellow-400 border border-white/10 hover:border-yellow-500/50 transition-all text-xs"
                      data-slug={post.slug}
                      data-status={isPublished ? "published" : "draft"}
                      title={
                        isPublished ? "Unpublish (Hide)" : "Publish (Show)"
                      }
                    >
                      {isPublished ? (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="w-4 h-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88"
                          />
                        </svg>
                      ) : (
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke-width="1.5"
                          stroke="currentColor"
                          class="w-4 h-4"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                          />
                        </svg>
                      )}
                    </button>
                    <button
                      class="delete-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/10 hover:border-red-500/50 transition-all text-xs"
                      data-slug={post.slug}
                      title="Delete Post"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-4 h-4"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0"
                        />
                      </svg>
                    </button>
                  </td>
                </tr>
              );
            })
          }
        </tbody>
      </table>
    </div>

    <div class="mt-6 flex justify-center">
      <button
        id="load-all-signals-btn"
        class="px-6 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-xs font-mono tracking-widest uppercase transition-colors text-gray-400 hover:text-white"
      >
        Load Full Archive
      </button>
    </div>
  </div>

  <!-- Editor Section -->
  <div class="glass-panel p-8 rounded-3xl">
    <h2 class="text-2xl font-bold mb-6">Transmission Uplink</h2>

    <!-- Quick Publish via File -->
    <div class="mb-12 p-6 rounded-2xl bg-white/5 border border-white/10">
      <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
        <span class="i-heroicons-document-arrow-up"></span>
        Direct Uplink (File)
      </h3>
      <p class="text-sm text-gray-400 mb-4">
        Upload <code>.md</code> or <code>.rtf</code> files to publish immediately.
      </p>
      <div class="flex items-center gap-4">
        <input
          type="file"
          id="quick-publish-file"
          accept=".md,.markdown,.rtf,.txt"
          class="block w-full text-sm text-gray-400
            file:mr-4 file:py-2 file:px-4
            file:rounded-full file:border-0
            file:text-xs file:font-bold
            file:bg-brand-accent/10 file:text-brand-accent
            hover:file:bg-brand-accent/20"
        />
        <button
          id="quick-publish-btn"
          class="px-5 py-2 whitespace-nowrap rounded-xl bg-white/10 hover:bg-white/20 border border-white/10 text-white font-medium transition-colors flex items-center gap-2"
        >
          <span class="i-heroicons-paper-airplane"></span>
          Publish
        </button>
      </div>
      <div id="quick-publish-status" class="mt-3 text-sm hidden"></div>
    </div>

    <form id="create-post-form" class="space-y-6">
      <input type="hidden" name="id" id="post-id" />
      <div class="grid grid-cols-3 gap-6">
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >SIGNAL_TITLE</label
          >
          <input
            type="text"
            name="title"
            id="title-input"
            required
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >SIGNAL_SLUG</label
          >
          <input
            type="text"
            name="slug"
            id="slug-input"
            required
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >PUBLISHED_AT</label
          >
          <input
            type="datetime-local"
            name="publishedAt"
            id="published-at-input"
            class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white calendar-picker-indicator:invert"
          />
          <p class="text-xs text-gray-500 mt-1">
            Set a past or future date to override publication time
          </p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm text-gray-400 mb-2 font-mono"
            >UPDATED_AT</label
          >
          <div class="flex items-center gap-4">
            <input
              type="datetime-local"
              name="updatedAt"
              id="updated-at-input"
              class="flex-grow bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:outline-none focus:border-brand-accent transition-colors text-white disabled:opacity-50"
              disabled
            />
            <label class="flex items-center gap-2 cursor-pointer group">
              <input
                type="checkbox"
                id="auto-update-toggle"
                checked
                class="w-5 h-5 rounded border-white/20 bg-white/5 text-brand-accent focus:ring-brand-accent focus:ring-offset-0 transition-all"
              />
              <span
                class="text-xs text-gray-400 group-hover:text-gray-200 transition-colors"
                >Auto-Update</span
              >
            </label>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Manually override modification time or keep it automatic
          </p>
        </div>
      </div>
    </form>

    <!-- Markdown Editor with Toolbar -->
    <div class="border border-white/10 rounded-xl overflow-hidden bg-black/20">
      <div
        class="flex items-center gap-2 p-2 border-b border-white/10 bg-white/5"
      >
        <button
          type="button"
          class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
          title="Bold">B</button
        >
        <button
          type="button"
          class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
          title="Italic">I</button
        >
        <div class="w-px h-6 bg-white/10 mx-2"></div>
        <button
          type="button"
          id="upload-btn"
          class="flex items-center gap-2 px-3 py-1.5 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors text-sm"
        >
          <span class="i-heroicons-photo"></span>
          Upload Media
        </button>
        <input
          type="file"
          id="file-input"
          class="hidden"
          accept="image/*, .gif, .ppt, .pptx, .doc, .docx, .xls, .xlsx, .csv"
        />
      </div>
      <textarea
        id="content-area"
        name="content"
        form="create-post-form"
        rows="15"
        required
        class="w-full bg-transparent p-4 focus:outline-none font-mono text-sm leading-relaxed resize-y"
        placeholder="Initiate transmission..."></textarea>
    </div>

    <div class="flex items-center gap-4">
      <button
        type="submit"
        form="create-post-form"
        class="relative z-10 flex-1 py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-accent hover:opacity-90 hover:scale-[1.01] active:scale-[0.98] text-white font-bold tracking-wider transition-all cursor-pointer shadow-lg hover:shadow-brand-accent/25"
      >
        BROADCAST SIGNAL
      </button>
      <button
        type="button"
        id="delete-current-btn"
        class="hidden px-6 py-4 rounded-xl bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 font-bold tracking-wider transition-colors"
      >
        <span class="i-heroicons-trash w-5 h-5"></span>
      </button>
    </div>

    <div id="status" class="hidden p-4 rounded-xl text-center text-sm"></div>
  </div>

  <!-- Success Modal Overlay -->
  <div
    id="success-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden opacity-0 transition-opacity duration-300 pointer-events-none"
  >
    <div class="relative w-full max-w-lg flex flex-col items-center">
      <!-- Glitch/Success Effect (Like 404) -->
      <div
        class="relative mb-8 transform scale-90 md:scale-100 transition-transform duration-300 delay-100 pointer-events-none"
      >
        <h1
          class="text-9xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-b from-white to-white/10 opacity-20 select-none"
        >
          200
        </h1>
        <div class="absolute inset-0 flex items-center justify-center">
          <h2
            class="text-4xl md:text-5xl font-bold font-display text-green-400 drop-shadow-[0_0_15px_rgba(74,222,128,0.5)] animate-pulse flex items-center justify-center gap-3 whitespace-nowrap"
          >
            <span class="i-heroicons-check-circle text-5xl"></span>
            <span>Signal Live!</span>
          </h2>
        </div>
      </div>

      <div
        class="glass-panel p-8 md:p-12 rounded-3xl w-full text-center transform scale-95 transition-transform duration-300 border border-white/10 shadow-2xl"
      >
        <p class="text-xl md:text-2xl font-medium text-white mb-4">
          Transmission Successful
        </p>
        <p class="text-gray-400 font-mono text-sm leading-relaxed mb-8">
          The signal has been injected into the network stream.<br />
          All systems operational.
        </p>

        <div class="flex flex-col gap-4 items-center w-full">
          <a
            id="verify-signal-btn"
            href="#"
            target="_blank"
            class="group relative w-full py-4 rounded-xl bg-gradient-to-r from-brand-primary to-brand-accent hover:opacity-90 text-white font-bold transition-all flex items-center justify-center gap-2 overflow-hidden shadow-[0_0_20px_rgba(139,92,246,0.3)] hover:shadow-[0_0_30px_rgba(139,92,246,0.5)]"
          >
            <div
              class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"
            >
            </div>
            <span class="relative z-10">Verify Signal</span>
            <span
              class="i-heroicons-arrow-top-right-on-square w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform"
            ></span>
          </a>

          <button
            id="return-uplink-btn"
            class="group relative w-full py-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/30 text-gray-400 hover:text-white transition-all flex items-center justify-center gap-2"
          >
            <span
              class="i-heroicons-arrow-path w-5 h-5 group-hover:-rotate-180 transition-transform duration-500"
            ></span>
            <span>Return to Uplink</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Active Network Sessions Modal -->
  <div
    id="active-sessions-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-all duration-300 pointer-events-none"
  >
    <div
      class="glass-panel w-full max-w-6xl max-h-[85vh] flex flex-col rounded-3xl overflow-hidden border border-white/10 shadow-2xl relative transform scale-95 transition-all duration-300"
    >
      <!-- Close Button -->
      <button
        class="close-inspect-btn absolute top-6 right-6 p-2 rounded-lg bg-black/20 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors border border-white/5 hover:border-red-500/30 z-20"
      >
        <span class="i-heroicons-x-mark w-6 h-6"></span>
      </button>

      <!-- Header -->
      <div
        class="p-6 border-b border-white/10 bg-black/40 flex justify-between items-center"
      >
        <div class="flex items-center gap-3">
          <span class="i-heroicons-globe-alt w-6 h-6 text-green-400"></span>
          <h2 class="text-xl font-bold font-display">
            Active Network Sessions
          </h2>
        </div>

        <!-- Logout All Button -->
        <button
          id="logout-all-btn"
          class="mr-12 px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 text-red-400 text-sm font-bold flex items-center gap-2 transition-all"
        >
          <span class="i-heroicons-power w-4 h-4"></span>
          Logout All Users
        </button>
      </div>

      <!-- Content -->
      <div
        class="overflow-y-auto p-0 scrollbar-hide flex-1 bg-black/20 relative"
      >
        <div
          class="p-6 bg-brand-primary/5 border-b border-white/5 text-sm text-gray-400 font-mono"
        >
          Monitoring <span class="text-white font-bold"
            >{(activeSessionsList.results || []).length}</span
          > active connections
        </div>
        <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-black/95 backdrop-blur-xl z-10">
            <tr
              class="text-gray-400 text-xs uppercase tracking-wider font-mono border-b border-white/10"
            >
              <th class="p-6 font-normal">User Identity</th>
              <th class="p-6 font-normal">Network (IP/Loc)</th>
              <th class="p-6 font-normal">Device Fingerprint</th>
              <th class="p-6 font-normal text-right">Last Echo</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-white/5">
            {
              (activeSessionsList.results || []).map((s: any) => (
                <tr class="hover:bg-white/5 transition-colors">
                  <td class="p-6">
                    <div class="flex items-center gap-3">
                      <img
                        src={
                          s.avatar ||
                          `https://ui-avatars.com/api/?name=${s.username || "?"}&background=random`
                        }
                        class="w-8 h-8 rounded-full border border-white/10"
                      />
                      <div>
                        <div class="font-bold text-white">
                          {s.username || "Unknown"}
                        </div>
                        <div class="text-xs text-gray-500 font-mono">
                          SID: {s.session_id.substring(0, 8)}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="p-6">
                    <div class="flex flex-col gap-1">
                      <div class="font-mono text-xs text-brand-accent bg-brand-accent/10 px-2 py-1 rounded inline-block border border-brand-accent/20 w-fit">
                        {s.ip_address || "Hidden"}
                      </div>
                      {s.city || s.country ? (
                        <div class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                          <span class="text-white font-medium">
                            {s.country || "??"}
                          </span>
                          <span>{s.city}</span>
                        </div>
                      ) : (
                        <div class="text-xs text-gray-500 mt-1">
                          Localhost / Unknown
                        </div>
                      )}
                    </div>
                  </td>
                  <td class="p-6">
                    <div
                      class="ua-parser-container text-xs text-gray-300 space-y-1"
                      data-ua={s.user_agent}
                    >
                      <div class="opacity-50">
                        Raw:{" "}
                        {s.user_agent
                          ? s.user_agent.substring(0, 30) + "..."
                          : "N/A"}
                      </div>
                    </div>
                  </td>
                  <td class="p-6 text-right">
                    <div class="text-white font-mono">
                      {s.last_active
                        ? new Date(s.last_active).toLocaleTimeString()
                        : "N/A"}
                    </div>
                    <div class="text-xs text-gray-500">
                      First:{" "}
                      {s.session_created
                        ? new Date(s.session_created).toLocaleDateString()
                        : "?"}
                    </div>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- User Database Modal -->
  <div
    id="user-database-modal"
    class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden opacity-0 transition-all duration-300 pointer-events-none"
  >
    <div
      class="glass-panel w-full max-w-6xl max-h-[85vh] flex flex-col rounded-3xl overflow-hidden border border-white/10 shadow-2xl relative transform scale-95 transition-all duration-300"
    >
      <!-- Close Button -->
      <button
        class="close-inspect-btn absolute top-6 right-6 p-2 rounded-lg bg-black/20 hover:bg-red-500/20 text-gray-400 hover:text-red-400 transition-colors border border-white/5 hover:border-red-500/30 z-20"
      >
        <span class="i-heroicons-x-mark w-6 h-6"></span>
      </button>

      <!-- Header -->
      <div
        class="p-6 border-b border-white/10 bg-black/40 flex items-center gap-3"
      >
        <span class="i-heroicons-users w-6 h-6 text-brand-accent"></span>
        <h2 class="text-xl font-bold font-display">User Database</h2>
      </div>

      <!-- Content -->
      <div
        class="overflow-y-auto p-0 scrollbar-hide flex-1 bg-black/20 relative"
      >
        <div
          class="p-6 bg-brand-accent/5 border-b border-white/5 text-sm text-gray-400 font-mono"
        >
          Found <span class="text-white font-bold"
            >{(usersList.results || []).length}</span
          > records (showing latest 100)
        </div>
        <table class="w-full text-left border-collapse">
          <thead
            class="sticky top-0 bg-black/95 backdrop-blur-xl z-10 box-decoration-clone"
          >
            <tr
              class="text-gray-400 text-xs uppercase tracking-wider font-mono border-b border-white/10"
            >
              <th class="p-6 font-normal">User</th>
              <th class="p-6 font-normal">Identity Provider</th>
              <th class="p-6 font-normal">IDs</th>
              <th class="p-6 font-normal text-right">Joined</th>
            </tr>
          </thead>
          <tbody class="text-sm divide-y divide-white/5">
            {
              (usersList.results || []).map((u: any) => (
                <tr class="hover:bg-white/5 transition-colors">
                  <td class="p-6">
                    <div class="flex items-center gap-3">
                      <img
                        src={
                          u.avatar ||
                          `https://ui-avatars.com/api/?name=${u.username}&background=random`
                        }
                        class="w-10 h-10 rounded-full object-cover border border-white/10"
                      />
                      <div>
                        <div class="font-bold text-white mb-0.5">
                          {u.username}
                        </div>
                        <div class="text-xs text-brand-accent/80 font-mono">
                          {u.id.substring(0, 8)}...
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="p-6">
                    <div class="flex gap-2">
                      {u.github_id && (
                        <span class="px-2 py-1 rounded bg-[#24292e]/50 border border-[#24292e]/50 text-xs text-gray-300 flex items-center gap-1">
                          <span class="i-simple-icons-github" /> GitHub
                        </span>
                      )}
                      {u.google_id && (
                        <span class="px-2 py-1 rounded bg-[#DB4437]/20 border border-[#DB4437]/30 text-xs text-red-200 flex items-center gap-1">
                          <span class="i-simple-icons-google" /> Google
                        </span>
                      )}
                      {u.discord_id && (
                        <span class="px-2 py-1 rounded bg-[#5865F2]/20 border border-[#5865F2]/30 text-xs text-indigo-200 flex items-center gap-1">
                          <span class="i-simple-icons-discord" /> Discord
                        </span>
                      )}
                    </div>
                  </td>
                  <td class="p-6 font-mono text-xs text-gray-500 space-y-1">
                    {u.github_username && (
                      <div class="flex items-center gap-2">
                        <span class="i-simple-icons-github w-4 h-4" />
                        <span>{u.github_username}</span>
                      </div>
                    )}
                    {u.google_username && (
                      <div class="flex items-center gap-2">
                        <span class="i-simple-icons-google w-4 h-4" />
                        <span>{u.google_username}</span>
                      </div>
                    )}
                    {u.discord_username && (
                      <div class="flex items-center gap-2">
                        <span class="i-simple-icons-discord w-4 h-4" />
                        <span>{u.discord_username}</span>
                      </div>
                    )}
                  </td>
                  <td class="p-6 text-right text-gray-400 font-mono text-xs">
                    {u.created_at
                      ? new Date(
                          typeof u.created_at === "number"
                            ? u.created_at
                            : parseInt(u.created_at) || 0,
                        ).toLocaleDateString()
                      : "N/A"}
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { hc } from "hono/client";
  import type { AppType } from "../../api/[...path]";
  import { UAParser } from "ua-parser-js";

  // Initialize UA Parser for all sessions
  document.querySelectorAll(".ua-parser-container").forEach((el) => {
    const ua = (el as HTMLElement).dataset.ua;
    if (ua) {
      const parser = new UAParser(ua);
      const result = parser.getResult();
      const osIcon = result.os.name?.toLowerCase().includes("mac")
        ? "i-simple-icons-apple"
        : result.os.name?.toLowerCase().includes("win")
          ? "i-simple-icons-windows"
          : result.os.name?.toLowerCase().includes("android")
            ? "i-simple-icons-android"
            : "i-heroicons-cpu-chip";

      el.innerHTML = `
        <div class="flex items-center gap-2">
          <span class="${osIcon} w-4 h-4"></span>
          <span class="font-bold">${result.os.name || "Unknown OS"} ${result.os.version || ""}</span>
        </div>
        <div class="flex items-center gap-2 text-gray-400">
           <span class="i-heroicons-computer-desktop w-4 h-4"></span>
           <span>${result.browser.name || "Unknown Browser"} ${result.browser.version || ""}</span>
        </div>
        ${result.device.type ? `<div class="text-xs text-gray-500 uppercase tracking-wide border border-white/10 inline-block px-1 rounded">${result.device.vendor || ""} ${result.device.model || ""}</div>` : ""}
      `;
    }
  });

  // No-op for compatibility if referenced elsewhere, or remove entirely if safe.
  // Legacy fetchGeoData removed as per user request to rely on DB data.

  // Tab Switcher Logic
  // @ts-ignore
  // --- Modals Logic ---
  const activeSessionsModal = document.getElementById("active-sessions-modal");
  const userDatabaseModal = document.getElementById("user-database-modal");

  const closeModals = () => {
    activeSessionsModal?.classList.add(
      "hidden",
      "opacity-0",
      "pointer-events-none",
    );
    userDatabaseModal?.classList.add(
      "hidden",
      "opacity-0",
      "pointer-events-none",
    );
    // Reset scales
    activeSessionsModal
      ?.querySelector(".glass-panel")
      ?.classList.remove("scale-100");
    activeSessionsModal
      ?.querySelector(".glass-panel")
      ?.classList.add("scale-95");
    userDatabaseModal
      ?.querySelector(".glass-panel")
      ?.classList.remove("scale-100");
    userDatabaseModal?.querySelector(".glass-panel")?.classList.add("scale-95");
  };

  document.querySelectorAll(".close-inspect-btn").forEach((btn) => {
    btn.addEventListener("click", closeModals);
  });

  // Close on click outside
  activeSessionsModal?.addEventListener("click", (e) => {
    if (e.target === activeSessionsModal) closeModals();
  });
  userDatabaseModal?.addEventListener("click", (e) => {
    if (e.target === userDatabaseModal) closeModals();
  });

  // Open Handlers
  // @ts-ignore
  window.openInspector = (type) => {
    if (type === "sessions") {
      activeSessionsModal?.classList.remove("hidden", "pointer-events-none");
      // Trigger reflow for transition
      void activeSessionsModal?.offsetWidth;
      activeSessionsModal?.classList.remove("opacity-0");
      activeSessionsModal
        ?.querySelector(".glass-panel")
        ?.classList.remove("scale-95");
      activeSessionsModal
        ?.querySelector(".glass-panel")
        ?.classList.add("scale-100");
    } else {
      userDatabaseModal?.classList.remove("hidden", "pointer-events-none");
      void userDatabaseModal?.offsetWidth;
      userDatabaseModal?.classList.remove("opacity-0");
      userDatabaseModal
        ?.querySelector(".glass-panel")
        ?.classList.remove("scale-95");
      userDatabaseModal
        ?.querySelector(".glass-panel")
        ?.classList.add("scale-100");
    }
  };

  // Logout All Users Logic
  const logoutAllBtn = document.getElementById("logout-all-btn");
  logoutAllBtn?.addEventListener("click", async () => {
    const confirmed = confirm(
      "CRITICAL: This will log out every active user (including you if you are using a session). Are you sure?",
    );
    if (!confirmed) return;

    logoutAllBtn.innerText = "Terminating...";
    (logoutAllBtn as HTMLButtonElement).disabled = true;

    try {
      const res = await fetch("/api/admin/sessions", { method: "DELETE" });
      if (res.ok) {
        alert("All sessions terminated. The grid will now reboot.");
        window.location.reload();
      } else {
        alert("Failed to terminate sessions.");
        logoutAllBtn.innerHTML =
          '<span class="i-heroicons-power w-4 h-4"></span> Logout All Users';
        (logoutAllBtn as HTMLButtonElement).disabled = false;
      }
    } catch (e) {
      console.error(e);
      alert("Network Error");
      logoutAllBtn.innerHTML =
        '<span class="i-heroicons-power w-4 h-4"></span> Logout All Users';
      (logoutAllBtn as HTMLButtonElement).disabled = false;
    }
  });

  const client = hc<AppType>(window.location.origin) as any;
  const form = document.getElementById("create-post-form") as HTMLFormElement;

  // Bind Edit Buttons (Recent List)
  const bindActionButtons = () => {
    document.querySelectorAll(".edit-post-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const slug = (e.currentTarget as HTMLElement).dataset.slug;
        if (slug) {
          loadPostForEdit(slug);
        }
      });
    });

    document.querySelectorAll(".toggle-status-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const target = e.currentTarget as HTMLElement;
        const slug = target.dataset.slug;
        const currentStatus = target.dataset.status;
        const action = currentStatus === "published" ? "unpublish" : "publish";

        if (!confirm(`Are you sure you want to ${action} this signal?`)) return;

        try {
          const res = await fetch(`/api/posts/${slug}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action }),
          });
          if (res.ok) {
            window.location.reload(); // Refresh to show status change
          } else {
            alert("Failed to update status");
          }
        } catch (err) {
          console.error(err);
        }
      });
    });

    document.querySelectorAll(".delete-post-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const slug = (e.currentTarget as HTMLElement).dataset.slug;
        if (
          !confirm("WARNING: This will permanently delete the signal. Proceed?")
        )
          return;

        try {
          const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
          if (res.ok) {
            window.location.reload();
          } else {
            alert("Failed to delete signal");
          }
        } catch (err) {
          console.error(err);
        }
      });
    });
  };

  bindActionButtons();

  // Ensure fresh state on navigation (fix BFCache)
  window.addEventListener("pageshow", () => {
    form.reset();
    document.getElementById("post-id")?.setAttribute("value", "");
    // Reset button text
    const btn = document.querySelector('button[type="submit"]');
    if (btn) btn.innerHTML = "BROADCAST SIGNAL";
  });
  const status = document.getElementById("status");
  const fileInput = document.getElementById("file-input") as HTMLInputElement;
  const uploadBtn = document.getElementById("upload-btn");
  const autoUpdateToggle = document.getElementById(
    "auto-update-toggle",
  ) as HTMLInputElement;
  const updatedAtInput = document.getElementById(
    "updated-at-input",
  ) as HTMLInputElement;

  autoUpdateToggle?.addEventListener("change", () => {
    updatedAtInput.disabled = autoUpdateToggle.checked;
    if (autoUpdateToggle.checked) {
      updatedAtInput.value = "";
    } else {
      // Set current time as default when unlocking
      const now = new Date();
      updatedAtInput.value = new Date(
        now.getTime() - now.getTimezoneOffset() * 60000,
      )
        .toISOString()
        .slice(0, 16);
    }
  });
  // @ts-ignore
  const textarea = document.getElementById(
    "content-area",
  ) as HTMLTextAreaElement;

  // File Upload Handler
  uploadBtn?.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", async (e) => {
    const file = (e.target as HTMLInputElement).files?.[0];
    if (!file) return;

    uploadBtn!.innerText = "Uploading...";

    try {
      const res = await fetch(
        `/api/upload?filename=${encodeURIComponent(file.name)}`,
        {
          method: "PUT",
          body: file,
        },
      );

      if (res.ok) {
        const data = (await res.json()) as any;
        // Insert Markdown Image syntax
        const cursorPosition = textarea.selectionStart;
        const textBefore = textarea.value.substring(0, cursorPosition);
        const textAfter = textarea.value.substring(
          cursorPosition,
          textarea.value.length,
        );
        const imageMarkdown = `\n![${file.name}](${data.url})\n`;

        textarea.value = textBefore + imageMarkdown + textAfter;
        uploadBtn!.innerHTML =
          '<span class="i-heroicons-check"></span> Uploaded';
        setTimeout(() => {
          uploadBtn!.innerHTML =
            '<span class="i-heroicons-photo"></span> Upload Media';
        }, 2000);
      }
    } catch (err) {
      console.error(err);
      uploadBtn!.innerText = "Failed";
    }
  });

  // Quick Publish Logic
  const quickPublishBtn = document.getElementById("quick-publish-btn");
  const quickPublishFile = document.getElementById(
    "quick-publish-file",
  ) as HTMLInputElement;
  const quickPublishStatus = document.getElementById("quick-publish-status");

  quickPublishBtn?.addEventListener("click", async () => {
    const file = quickPublishFile?.files?.[0];
    if (!file) {
      alert("Please select a file first.");
      return;
    }

    if (!confirm(`Ready to broadcast ${file.name}?`)) return;

    quickPublishBtn.innerHTML =
      '<span class="animate-spin i-heroicons-arrow-path"></span> Broadcasting...';
    (quickPublishBtn as HTMLButtonElement).disabled = true;
    quickPublishStatus!.classList.add("hidden");

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("/api/posts/upload", {
        method: "POST",
        body: formData,
      });

      const result = (await res.json()) as any;

      if (res.ok) {
        quickPublishStatus!.innerHTML = `<span class="text-green-400">âœ“ Signal Live: <a href="/blog/${result.slug}" target="_blank" class="underline hover:text-white">${result.slug}</a></span>`;
        quickPublishStatus!.classList.remove("hidden");
        quickPublishFile.value = "";

        // Reload list after short delay
        setTimeout(() => window.location.reload(), 1500);
      } else {
        throw new Error(result.error || "Upload failed");
      }
    } catch (e: any) {
      console.error(e);
      quickPublishStatus!.innerHTML = `<span class="text-red-400">âš  Transmission Error: ${e.message}</span>`;
      quickPublishStatus!.classList.remove("hidden");
    } finally {
      quickPublishBtn.innerHTML =
        '<span class="i-heroicons-paper-airplane"></span> Publish';
      (quickPublishBtn as HTMLButtonElement).disabled = false;
    }
  });

  // Post Submission
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    status!.className = "hidden p-4 rounded-xl text-center text-sm";

    // Validation Check
    if (!formData.get("title") || !formData.get("slug")) {
      alert("Missing Critical Data: Title or Slug required.");
      return;
    }

    // Verify FormData capture
    console.log("ðŸ“¦ Form Payload:", Object.fromEntries(formData));

    try {
      const res = await client.api.posts.$post({
        form: {
          id: formData.get("id") as string,
          title: formData.get("title") as string,
          slug: formData.get("slug") as string,
          content: formData.get("content") as string,
          publishedAt: formData.get("publishedAt") as string,
          updatedAt: formData.get("updatedAt") as string,
        },
      });

      if (res.ok) {
        // ... (success logic remains the same)
        const modal = document.getElementById("success-modal");
        const verifyBtn = document.getElementById(
          "verify-signal-btn",
        ) as HTMLAnchorElement;
        const returnBtn = document.getElementById("return-uplink-btn");
        const slug = formData.get("slug") as string;

        verifyBtn.href = `/blog/${slug}`;

        modal?.classList.remove("hidden", "pointer-events-none");
        void modal?.offsetWidth;
        modal?.classList.remove("opacity-0");
        modal?.querySelector(".glass-panel")?.classList.remove("scale-95");
        modal?.querySelector(".glass-panel")?.classList.add("scale-100");

        form.reset();
        document.getElementById("delete-current-btn")?.classList.add("hidden");
        document.querySelector('button[type="submit"]')!.innerHTML =
          "BROADCAST SIGNAL";

        returnBtn?.addEventListener("click", () => {
          modal?.classList.add("opacity-0", "pointer-events-none");
          modal?.querySelector(".glass-panel")?.classList.add("scale-95");
          setTimeout(() => modal?.classList.add("hidden"), 300);
          window.location.reload();
        });
      } else {
        const errorData = (await res
          .json()
          .catch(() => ({ error: res.statusText }))) as any;
        console.error("Transmission Error:", errorData);
        status!.innerText = `Transmission Failed: ${errorData.error || "Unknown Error"} (${res.status})`;
        status!.classList.remove("hidden");
        status!.classList.add("bg-red-500/20", "text-red-200");
      }
    } catch (err) {
      console.error(err);
      status!.innerText = "Network Error.";
      status!.classList.remove("hidden");
      status!.classList.add("bg-red-500/20", "text-red-200");
    }
  });

  // Handle Delete from Editor
  const deleteCurrentBtn = document.getElementById("delete-current-btn");
  deleteCurrentBtn?.addEventListener("click", async () => {
    const slug = (document.getElementById("slug-input") as HTMLInputElement)
      .value;
    if (!slug) return;

    if (
      !confirm(
        "CRITICAL WARNING: This will permanently purge this signal from the database. This action is irreversible. Proceed?",
      )
    )
      return;

    try {
      const res = await fetch(`/api/posts/${slug}`, { method: "DELETE" });
      if (res.ok) {
        window.location.reload();
      } else {
        alert("Failed to delete signal");
      }
    } catch (err) {
      console.error(err);
      alert("Network Error");
    }
  });

  // --- Global Search Logic ---
  const searchInput = document.getElementById(
    "admin-search-input",
  ) as HTMLInputElement;
  const resultsContainer = document.getElementById("admin-search-results");
  let debounceTimer: ReturnType<typeof setTimeout>;

  async function loadPostForEdit(slug: string) {
    try {
      const res = await fetch(`/api/posts/${slug}`);
      if (res.ok) {
        const post = (await res.json()) as any;
        // Populate Form
        (document.getElementById("post-id") as HTMLInputElement).value =
          post.id;
        (document.getElementById("title-input") as HTMLInputElement).value =
          post.title;
        (document.getElementById("slug-input") as HTMLInputElement).value =
          post.slug;
        (document.getElementById("content-area") as HTMLTextAreaElement).value =
          post.content;

        if (post.publishedAt) {
          const date = new Date(post.publishedAt);
          const iso = new Date(
            date.getTime() - date.getTimezoneOffset() * 60000,
          )
            .toISOString()
            .slice(0, 16);
          (
            document.getElementById("published-at-input") as HTMLInputElement
          ).value = iso;
        }

        if (post.updatedAt) {
          const date = new Date(post.updatedAt);
          const iso = new Date(
            date.getTime() - date.getTimezoneOffset() * 60000,
          )
            .toISOString()
            .slice(0, 16);
          updatedAtInput.value = iso;
          autoUpdateToggle.checked = false;
          updatedAtInput.disabled = false;
        } else {
          updatedAtInput.value = "";
          autoUpdateToggle.checked = true;
          updatedAtInput.disabled = true;
        }

        // Scroll to editor
        document
          .getElementById("create-post-form")
          ?.scrollIntoView({ behavior: "smooth" });

        // Update Button Text & Show Delete
        const btn = document.querySelector('button[type="submit"]');
        if (btn) btn.innerHTML = "UPDATE SIGNAL";

        document
          .getElementById("delete-current-btn")
          ?.classList.remove("hidden");
      }
    } catch (e) {
      console.error("Failed to load post", e);
    }
  }

  if (searchInput && resultsContainer) {
    searchInput.addEventListener("input", (e) => {
      const query = (e.target as HTMLInputElement).value;
      clearTimeout(debounceTimer);

      if (query.length < 2) {
        resultsContainer.classList.add("hidden");
        return;
      }

      debounceTimer = setTimeout(async () => {
        try {
          const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
          const matches = (await res.json()) as any[];

          if (matches.length > 0) {
            resultsContainer.innerHTML = matches
              .map(
                (match: any) => `
                          <div data-slug="${match.metadata.slug}" class="search-result-item block p-3 hover:bg-white/10 rounded-xl transition-colors cursor-pointer">
                              <div class="font-bold text-white text-sm">${match.metadata.title}</div>
                              <div class="text-xs text-brand-accent mt-1">${(match.score * 100).toFixed(1)}% Match â€¢ Click to Edit</div>
                          </div>
                      `,
              )
              .join("");
            resultsContainer.classList.remove("hidden");

            // Add click listeners to results
            document.querySelectorAll(".search-result-item").forEach((item) => {
              item.addEventListener("click", async (ev) => {
                const slug = (ev.currentTarget as HTMLElement).dataset.slug;
                console.log("Loading post:", slug);
                loadPostForEdit(slug!);
                resultsContainer.classList.add("hidden");
              });
            });
          } else {
            resultsContainer.innerHTML =
              '<div class="p-3 text-sm text-gray-500 text-center">No signals found.</div>';
            resultsContainer.classList.remove("hidden");
          }
        } catch (err) {
          console.error(err);
        }
      }, 300);
    });

    // Hide on click outside
    document.addEventListener("click", (e) => {
      if (
        !searchInput.contains(e.target as Node) &&
        !resultsContainer.contains(e.target as Node)
      ) {
        resultsContainer.classList.add("hidden");
      }
    });

    // Load All Archives Logic
    const loadAllBtn = document.getElementById("load-all-signals-btn");
    const tableBody = document.getElementById("signal-log-body");

    loadAllBtn?.addEventListener("click", async () => {
      loadAllBtn.innerText = "Loading Archive...";
      loadAllBtn.setAttribute("disabled", "true");

      try {
        const res = await fetch("/api/posts?limit=all");
        const allPosts = (await res.json()) as any[];

        if (tableBody) {
          tableBody.innerHTML = allPosts
            .map((post) => {
              const isPublished = Date.now() >= (post.publishedAt || 0);
              const dateStr = new Date(
                post.publishedAt || post.createdAt,
              ).toLocaleDateString();

              return `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors group">
                      <td class="py-4">
                        <span class="inline-block w-2 h-2 rounded-full ${isPublished ? "bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.5)]" : "bg-yellow-400"}"></span>
                      </td>
                      <td class="py-4 font-medium text-white">${post.title}</td>
                      <td class="py-4 text-gray-400 font-mono text-xs">${dateStr}</td>
                      <td class="py-4 text-gray-400 font-mono text-xs text-right">
                          <span class="inline-flex items-center gap-1 bg-white/5 px-2 py-1 rounded">
                             <span class="i-heroicons-eye w-3 h-3"></span> ${post.views || 0}
                          </span>
                      </td>
                      <td class="py-4 text-right flex items-center justify-end gap-2">
                        <button class="edit-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-brand-primary/20 text-gray-300 hover:text-brand-accent border border-white/10 hover:border-brand-primary/50 transition-all text-xs" data-slug="${post.slug}" title="Edit Post">
                          <span class="i-heroicons-pencil-square w-4 h-4"></span>
                        </button>
                        <button class="toggle-status-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-yellow-500/20 text-gray-300 hover:text-yellow-400 border border-white/10 hover:border-yellow-500/50 transition-all text-xs" data-slug="${post.slug}" data-status="${isPublished ? "published" : "draft"}" title="${isPublished ? "Unpublish (Hide)" : "Publish (Show)"}">
                          <span class="${isPublished ? "i-heroicons-eye-slash w-4 h-4" : "i-heroicons-eye w-4 h-4"}"></span>
                        </button>
                        <button class="delete-post-btn px-3 py-1 rounded-lg bg-white/5 hover:bg-red-500/20 text-gray-300 hover:text-red-400 border border-white/10 hover:border-red-500/50 transition-all text-xs" data-slug="${post.slug}" title="Delete Post">
                          <span class="i-heroicons-trash w-4 h-4"></span>
                        </button>
                      </td>
                    </tr>
                    `;
            })
            .join("");

          // Re-bind buttons since DOM changed
          bindActionButtons();

          loadAllBtn.classList.add("hidden");
          const countEl = document.getElementById("signal-log-count");
          if (countEl)
            countEl.innerText = `Showing All ${allPosts.length} Signals`;
        }
      } catch (e) {
        console.error(e);
        loadAllBtn.innerText = "Sync Failed";
      }
    });
  }
</script>
