---
import { desc, lte } from "drizzle-orm";
import { posts } from "../../../db/schema";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import { getDb } from "../../lib/db";

import Layout from "../../layouts/Layout.astro";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Access Cloudflare bindings from locals
const runtime = Astro.locals.runtime;
const env = runtime?.env || ({} as any);

// Initialize Cache
import { getCache } from "../../lib/cache";

let cache;
try {
  cache = getCache(env);
} catch (e) {
  console.error("Cache initialization failed:", e);
}

let recentPosts: (typeof posts.$inferSelect)[] = [];
const CACHE_KEY = "home_recent_posts_zh";
const CACHE_TTL = 300;

try {
  const fetchPosts = async () => {
    const db = getDb(env);
    return await db
      .select()
      .from(posts)
      .where(lte(posts.publishedAt, Date.now()))
      .orderBy(desc(posts.publishedAt))
      .limit(3);
  };

  if (cache) {
    recentPosts = await cache.getOrSet(CACHE_KEY, fetchPosts, CACHE_TTL);
  } else {
    recentPosts = await fetchPosts();
  }
} catch (e) {
  console.error("Failed to fetch posts:", e);
  // Fallback if needed
}
---

<Layout title={t("hero.title")}>
  <!-- Top Banner / Header already in Layout, but we might want a specific layout adjustment or spacer -->
  <div
    class="grid grid-cols-1 md:grid-cols-3 gap-6 auto-rows-[minmax(180px,auto)] mb-12"
  >
    <!-- The Crystal Logic Hero (2x1) -->
    <div
      class="md:col-span-2 glass-panel p-6 md:p-10 flex flex-col justify-center rounded-3xl relative overflow-hidden group animate-fade-in-up"
    >
      <div
        class="absolute inset-0 bg-gradient-to-br from-purple-900/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"
      >
      </div>
      <div class="relative z-10">
        <h1
          class="text-3xl md:text-5xl font-display font-bold mb-2 md:mb-4 tracking-tight"
        >
          <span
            class="bg-clip-text text-transparent bg-gradient-to-r from-white via-gray-200 to-gray-400"
          >
            {t("hero.title")}
          </span>
        </h1>
        <p class="text-gray-400 text-sm md:text-lg">
          {t("hero.subtitle")}
        </p>
      </div>
    </div>

    <!-- System Status (1x1) -->
    <div
      class="glass-panel p-8 flex flex-col justify-between rounded-3xl relative overflow-hidden animate-fade-in-up animate-delay-100"
    >
      <div>
        <div
          class="font-mono text-xs text-brand-accent mb-4 tracking-widest uppercase"
        >
          {t("home.system_status")}
        </div>
        <div class="text-3xl font-display font-bold">
          {t("home.operational")}
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        <span class="text-xs text-gray-500 font-mono"
          >{t("home.all_systems_normal")}</span
        >
      </div>
    </div>

    <!-- Recent Posts (1x2 Vertical) -->
    <div
      class="glass-panel p-8 rounded-3xl flex flex-col justify-between relative overflow-hidden group md:row-span-2 max-h-[500px] animate-fade-in-up animate-delay-200"
    >
      <h2 class="text-xl font-bold mb-6">{t("home.recent_posts")}</h2>

      <div class="flex flex-col gap-4 overflow-y-auto pr-2 custom-scrollbar">
        {
          recentPosts.length > 0 ? (
            recentPosts.map((post) => (
              <a
                href={`/zh/blog/${post.slug}`}
                data-astro-prefetch
                class="block group/item hover:bg-white/5 p-4 rounded-xl transition-colors border border-transparent hover:border-white/5"
              >
                <h3
                  class="font-bold text-sm text-gray-200 group-hover/item:text-brand-accent transition-colors line-clamp-2"
                  transition:name={`title-${post.slug}`}
                >
                  {post.title}
                </h3>
                <span class="text-xs text-gray-500 mt-2 block font-mono">
                  {new Date(
                    post.publishedAt || post.createdAt,
                  ).toLocaleDateString()}
                </span>
              </a>
            ))
          ) : (
            <div class="text-gray-500 text-sm italic">
              {t("home.no_signals")}
            </div>
          )
        }
      </div>

      <div class="mt-4 pt-4 border-t border-white/5">
        <a
          href="/zh/blog"
          data-astro-prefetch
          class="text-xs text-gray-400 hover:text-white flex items-center gap-2 transition-colors"
        >
          {t("home.view_archive")}
          <span class="i-heroicons-arrow-right text-xs"></span>
        </a>
      </div>
    </div>

    <!-- Gallery (1x1) -->
    <a
      href="/zh/gallery"
      data-astro-prefetch
      class="glass-panel p-8 flex flex-col justify-between rounded-3xl group hover:bg-white/5 transition-colors relative overflow-hidden animate-fade-in-up animate-delay-300"
    >
      <div
        class="absolute -right-4 -bottom-4 text-9xl text-white/5 i-heroicons-photo rotate-12 group-hover:rotate-6 transition-transform duration-500"
      >
      </div>
      <div class="mt-auto relative z-10">
        <h2 class="text-xl font-bold">{t("home.gallery")}</h2>
      </div>
    </a>

    <!-- Projects (1x1) -->
    <a
      href="/zh/projects"
      data-astro-prefetch
      class="glass-panel p-8 flex flex-col justify-between rounded-3xl group hover:bg-white/5 transition-colors relative overflow-hidden animate-fade-in-up animate-delay-400"
    >
      <div
        class="absolute -right-4 -bottom-4 text-9xl text-white/5 i-heroicons-beaker rotate-12 group-hover:rotate-6 transition-transform duration-500"
      >
      </div>
      <div class="mt-auto relative z-10">
        <h2 class="text-xl font-bold">{t("home.projects")}</h2>
      </div>
    </a>

    <!-- Bottom Spacer / Infinite Scroll Placeholder -->
    <div
      class="md:col-span-3 h-32 flex items-center justify-center opacity-30 mt-8"
    >
      <span class="i-heroicons-chevron-down text-3xl animate-bounce"></span>
    </div>
  </div>
</Layout>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.2);
  }
</style>
