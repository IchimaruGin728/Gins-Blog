---
import { desc, lte } from "drizzle-orm";
import { posts } from "../../../../db/schema";
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";
import { getDb } from "../../../lib/db";

const lang = getLangFromUrl(Astro.url);
// biome-ignore lint/correctness/noUnusedVariables: Used in template
const t = useTranslations(lang);

// Access Cloudflare bindings from locals
const runtime = Astro.locals.runtime;
const env = runtime?.env || ({} as any);

let _allPosts: (typeof posts.$inferSelect)[] = [];
let _error = null;

try {
	if (env.DB) {
		const db = getDb(env);
		_allPosts = await db
			.select()
			.from(posts)
			.where(lte(posts.publishedAt, Date.now()))
			.orderBy(desc(posts.publishedAt))
			.all();
	} else {
		console.warn("No DB binding found, serving empty blog list (ZH)");
	}
} catch (e: any) {
	console.error("Failed to fetch posts:", e);
	// Fallback empty
	_allPosts = [];
	_error = e.message;
}
---

<Layout title={`${t("nav.blog")} - ${t("hero.title")}`}>
  <div class="mb-12">
    <h1 class="text-4xl font-display font-bold mb-4">
      {t("blog.latest_thoughts")}
      <span class="text-brand-accent">{t("blog.thoughts_highlight")}</span>
    </h1>
    <p class="text-gray-400">
      {t("blog.musings")}
    </p>
  </div>

  {
    error && (
      <div class="p-4 mb-8 border border-red-500/20 bg-red-500/10 rounded-lg text-red-400">
        <p class="font-bold">Database Error</p>
        <p class="text-sm">{error}. Ensure D1 is bound correctly.</p>
      </div>
    )
  }

  <div class="grid gap-8 md:grid-cols-2">
    {
      allPosts.map((post) => (
        <a
          href={`/zh/blog/${post.slug}`}
          data-astro-prefetch
          class="group glass-panel rounded-3xl p-8 hover:bg-white/5 transition-all relative overflow-hidden"
        >
          <div class="absolute inset-0 bg-gradient-to-r from-brand-primary/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />

          <div class="relative z-10">
            <div class="flex items-center gap-3 text-xs font-mono text-brand-accent mb-3">
              <span>
                {new Date(
                  post.publishedAt || post.createdAt,
                ).toLocaleDateString()}
              </span>
              <span class="w-1 h-1 rounded-full bg-brand-accent/50" />
              <span class="flex items-center gap-1">
                <span class="i-heroicons-eye w-3 h-3" />
                {post.views}
              </span>
            </div>
            <h2 class="text-2xl font-bold mb-3 group-hover:text-brand-accent transition-colors">
              {post.title}
            </h2>
            <p class="text-gray-400 line-clamp-3">
              {post.content.slice(0, 150)}...
            </p>
          </div>
        </a>
      ))
    }

    {
      allPosts.length === 0 && !error && (
        <div class="col-span-full py-20 text-center text-gray-500 bg-white/5 rounded-3xl border border-white/5 font-mono">
          // NO_DATA_FOUND
        </div>
      )
    }
  </div>
</Layout>
