---
import Layout from "../../../layouts/Layout.astro";
import { getDb } from "../../../lib/db";
import { posts } from "../../../../db/schema";
import { desc, lte } from "drizzle-orm";
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Access Cloudflare bindings from locals
const { env } = Astro.locals.runtime;

let allPosts: (typeof posts.$inferSelect)[] = [];
let error = null;

try {
  const db = getDb(env);
  allPosts = await db
    .select()
    .from(posts)
    .where(lte(posts.publishedAt, Date.now()))
    .orderBy(desc(posts.publishedAt))
    .all();
} catch (e: any) {
  console.error("Failed to fetch posts:", e);
  error = e.message;
}
---

<Layout title={`${t("nav.blog")} - ${t("hero.title")}`}>
  <div class="mb-12">
    <h1 class="text-4xl font-display font-bold mb-4">
      {t("blog.latest_thoughts")}
      <span class="text-brand-accent">{t("blog.thoughts_highlight")}</span>
    </h1>
    <p class="text-gray-400">
      {t("blog.musings")}
    </p>
  </div>

  {
    error && (
      <div class="p-4 mb-8 border border-red-500/20 bg-red-500/10 rounded-lg text-red-400">
        <p class="font-bold">Database Error</p>
        <p class="text-sm">{error}. Ensure D1 is bound correctly.</p>
      </div>
    )
  }

  <div class="grid gap-8 md:grid-cols-2">
    {
      allPosts.map((post) => (
        <a
          href={`/zh-SG/blog/${post.slug}`}
          class="group glass-panel rounded-3xl p-8 hover:bg-white/5 transition-all relative overflow-hidden"
        >
          <div class="absolute inset-0 bg-gradient-to-r from-brand-primary/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />

          <div class="relative z-10">
            <div class="text-xs font-mono text-brand-accent mb-3">
              {new Date(
                post.publishedAt || post.createdAt,
              ).toLocaleDateString()}
            </div>
            <h2 class="text-2xl font-bold mb-3 group-hover:text-brand-accent transition-colors">
              {post.title}
            </h2>
            <p class="text-gray-400 line-clamp-3">
              {post.content.slice(0, 150)}...
            </p>
          </div>
        </a>
      ))
    }

    {
      allPosts.length === 0 && !error && (
        <div class="col-span-full py-20 text-center text-gray-500 bg-white/5 rounded-3xl border border-white/5 font-mono">
          // NO_DATA_FOUND
        </div>
      )
    }
  </div>
</Layout>
